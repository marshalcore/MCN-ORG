<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Marshal Core Nigeria | Application Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://js.paystack.co/v1/inline.js"></script>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary-red: #d32f2f;
      --primary-navy: #1a237e;
      --secondary-blue: #254a93;
      --light-bg: #f8f9fa;
      --dark-text: #333;
    }

    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Header */
    .header_section {
      background: var(--primary-navy);
      padding: 10px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .rc-number {
      color: white;
      font-weight: bold;
      font-size: 14px;
      background: rgba(255,255,255,0.1);
      padding: 5px 10px;
      border-radius: 4px;
    }

    .logo_box img {
      height: 60px;
      width: auto;
      display: block;
      max-height: 60px;
      object-fit: contain;
    }

    .nav-link {
      color: white !important;
      font-weight: 500;
      padding: 10px 15px !important;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      color: #ffd700 !important;
      transform: translateY(-2px);
    }

    /* Progress Bar */
    .progress-container {
      background: white;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      max-width: 900px;
      border-left: 5px solid var(--primary-red);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin: 30px 0;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .progress-bar {
      position: absolute;
      top: 50%;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--secondary-blue));
      transform: translateY(-50%);
      z-index: 2;
      transition: width 0.5s ease;
      width: 0%;
    }

    .step {
      position: relative;
      z-index: 3;
      text-align: center;
      width: 120px;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s ease;
      font-size: 16px;
    }

    .step.active .step-circle {
      background: var(--primary-red);
      border-color: var(--primary-red);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 0 0 5px rgba(211, 47, 47, 0.2);
    }

    .step.completed .step-circle {
      background: var(--secondary-blue);
      border-color: var(--secondary-blue);
      color: white;
    }

    .step.completed .step-circle::after {
      content: '‚úì';
      font-size: 18px;
    }

    .step-label {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .step.active .step-label {
      color: var(--primary-red);
      font-weight: 600;
    }

    /* Main Content */
    .main-container {
      padding: 30px 0;
      min-height: calc(100vh - 200px);
    }

    .section-container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .section-container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card Styling */
    .card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      margin: 20px auto;
      max-width: 900px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-red), var(--secondary-blue));
    }

    .card h2 {
      color: var(--primary-navy);
      margin-bottom: 20px;
      font-size: 2rem;
      font-weight: 700;
      border-bottom: 2px solid #eee;
      padding-bottom: 15px;
    }

    .card h3 {
      color: var(--secondary-blue);
      margin: 25px 0 15px;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .card-description {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary-navy);
      font-size: 0.95rem;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary-blue);
      background: white;
      box-shadow: 0 0 0 3px rgba(37, 74, 147, 0.1);
    }

    .form-control::placeholder {
      color: #999;
    }

    /* Category Cards */
    .category-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .category-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }

    .category-card:hover {
      transform: translateY(-5px);
      border-color: var(--secondary-blue);
      box-shadow: 0 10px 30px rgba(37, 74, 147, 0.15);
    }

    .category-card.selected {
      border-color: var(--primary-red);
      background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
    }

    .category-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--secondary-blue);
    }

    .category-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-navy);
      margin-bottom: 10px;
    }

    .category-description {
      color: #666;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* Buttons */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-red), #c62828);
      color: white;
      border: 2px solid var(--primary-red);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
      background: linear-gradient(135deg, #c62828, var(--primary-red));
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary-blue), #1c3d8c);
      color: white;
      border: 2px solid var(--secondary-blue);
    }

    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(37, 74, 147, 0.3);
      background: linear-gradient(135deg, #1c3d8c, var(--secondary-blue));
      color: white;
    }

    .btn-lg {
      padding: 16px 40px;
      font-size: 1.1rem;
    }

    .btn-full {
      width: 100%;
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Status Messages */
    .status-message {
      padding: 16px 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .status-success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }

    .status-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid var(--primary-red);
    }

    .status-warning {
      background: #fff3e0;
      color: #ef6c00;
      border-left: 4px solid #ff9800;
    }

    .status-info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed #bdbdbd;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      transition: all 0.3s ease;
      background: #fafafa;
      cursor: pointer;
    }

    .file-upload:hover {
      border-color: var(--secondary-blue);
      background: #f5f5f5;
    }

    .file-upload.dragover {
      border-color: var(--primary-red);
      background: #ffeaea;
    }

    .upload-icon {
      font-size: 3rem;
      color: #757575;
      margin-bottom: 15px;
    }

    .file-input {
      display: none;
    }

    .file-label {
      background: linear-gradient(135deg, var(--secondary-blue), var(--primary-navy));
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .file-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 74, 147, 0.3);
    }

    .file-info {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #666;
    }

    .file-preview {
      margin-top: 20px;
      display: none;
    }

    .preview-container {
      display: flex;
      align-items: center;
      gap: 15px;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
    }

    .preview-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .preview-details {
      flex: 1;
    }

    .preview-name {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .preview-size {
      font-size: 0.9rem;
      color: #666;
    }

    .remove-file {
      background: var(--primary-red);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .remove-file:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    /* Terms & Conditions */
    .terms-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin: 20px 0;
    }

    .terms-content {
      line-height: 1.8;
      color: #555;
    }

    .terms-content h4 {
      color: var(--primary-red);
      margin: 20px 0 10px;
      font-size: 1.2rem;
    }

    .terms-content ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .terms-content li {
      margin-bottom: 8px;
    }

    .scroll-indicator {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
      margin: 10px 0;
      font-style: italic;
      padding: 10px;
      background: #f0f7ff;
      border-radius: 5px;
    }

    /* Checkbox */
    .checkbox-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 10px;
      margin: 25px 0;
      border: 1px solid #cce7ff;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--primary-red);
    }

    .checkbox-container label {
      flex: 1;
      cursor: pointer;
      line-height: 1.5;
      color: #333;
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 60px 40px;
    }

    .success-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary-red), var(--secondary-blue));
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0 auto 30px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 74, 147, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(37, 74, 147, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 74, 147, 0); }
    }

    .success-title {
      color: var(--primary-red);
      font-size: 2.2rem;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .success-message {
      color: #666;
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }

    .download-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .download-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .download-card:hover {
      border-color: var(--primary-red);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(211, 47, 47, 0.15);
    }

    .download-icon {
      font-size: 2.5rem;
      color: var(--secondary-blue);
      margin-bottom: 15px;
    }

    /* Continue Application Box */
    .continue-box {
      background: #e8f5e9;
      border-radius: 10px;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #4CAF50;
      text-align: center;
    }

    .continue-box h4 {
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .continue-status {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed #ddd;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      color: #666;
    }

    .status-value {
      color: #333;
      font-weight: 500;
    }

    /* Loader */
    .loader-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 1.2rem;
      color: var(--primary-red);
      font-weight: 600;
    }

    /* Footer */
    .footer_section {
      background: var(--primary-navy);
      color: white;
      padding: 40px 0;
      margin-top: 60px;
    }

    .footer-content {
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer-logo {
      height: 50px;
      margin-bottom: 20px;
      display: inline-block;
      max-height: 50px;
      object-fit: contain;
    }

    .contact-info {
      margin: 20px 0;
      font-size: 0.95rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .copyright {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Payment Amount */
    .payment-amount {
      text-align: center;
      font-size: 3rem;
      font-weight: 800;
      color: var(--primary-red);
      margin: 30px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .payment-summary {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid var(--primary-red);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .progress-container {
        padding: 15px;
        margin: 10px;
      }

      .progress-steps {
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .step {
        width: 100px;
      }

      .card {
        padding: 25px 20px;
        margin: 10px;
      }

      .category-cards {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .payment-amount {
        font-size: 2.2rem;
      }

      .success-screen {
        padding: 40px 20px;
      }

      .success-title {
        font-size: 1.8rem;
      }
    }

    @media (max-width: 576px) {
      .step {
        width: 80px;
      }

      .step-circle {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .step-label {
        font-size: 0.75rem;
      }

      .card h2 {
        font-size: 1.6rem;
      }

      .category-card {
        padding: 20px;
      }

      .category-title {
        font-size: 1.2rem;
      }
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    .hidden { display: none !important; }
    .optional-badge {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-left: 8px;
    }

    /* Save Progress Button */
    .save-progress-btn {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      border: 2px solid #ff9800;
    }

    .save-progress-btn:hover {
      background: linear-gradient(135deg, #f57c00, #ff9800);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(245, 124, 0, 0.3);
    }

    /* Application Status */
    .application-status {
      background: #f0f7ff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.saved {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-badge.submitted {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.pending {
      background: #fff3e0;
      color: #ef6c00;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header_section">
    <div class="container">
      <nav class="navbar navbar-expand-lg custom_nav-container">
        <a class="navbar-brand" href="index.html">
          <span class="rc-number">YA/CLB/10100</span>
          <div class="logo_box">
            <img src="images/logo.png" alt="Marshal Core Logo" onerror="this.onerror=null;this.src='images/logo.png';">
          </div>
        </a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Status Messages -->
    <div class="container">
      <div id="statusMessage" class="status-message"></div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-bar" id="progressBar"></div>
        <div class="step active" data-step="0">
          <div class="step-circle">1</div>
          <div class="step-label">Terms & Conditions</div>
        </div>
        <div class="step" data-step="1">
          <div class="step-circle">2</div>
          <div class="step-label">Select Category</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-circle">3</div>
          <div class="step-label">Check Status</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-circle">4</div>
          <div class="step-label">Payment</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-circle">5</div>
          <div class="step-label">Application</div>
        </div>
      </div>
    </div>

    <!-- Section 1: Terms & Conditions -->
    <div class="section-container active" id="section1">
      <div class="card">
        <h2>üìã Terms & Conditions</h2>
        <p class="card-description">
          Please read and accept the Terms & Conditions before proceeding with your application.
        </p>
        
        <div class="terms-container">
          <div class="terms-content">
            <h4>MARSHAL CORE OF NIGERIA - TERMS OF SERVICE</h4>
            <p>This is a legally binding agreement between Marshal Core of Nigeria (hereinafter referred to as "the Organization") and the Applicant/Officer.</p>
            
            <h4>GENERAL REQUIREMENTS</h4>
            <ul>
              <li><strong>Age Requirements:</strong>
                <ul>
                  <li>Regular Officers: 18 years and above</li>
                  <li>Marshal Cadets: 14-17 years</li>
                  <li>VIP Officers: 25 years and above</li>
                </ul>
              </li>
              <li>Must be medically and physically fit</li>
              <li>Must be psychologically fit to train</li>
              <li>Must speak English and any two additional languages</li>
              <li>Must have a guarantor who can vouch for you</li>
              <li>NIN is recommended but optional for initial application</li>
            </ul>
            
            <h4>APPLICATION FEES</h4>
            <ul>
              <li>Regular Cadre: ‚Ç¶5,180 (Online form only)</li>
              <li>VIP Cadre: ‚Ç¶25,900 (Online form only)</li>
            </ul>
            
            <h4>UNIFORM AND TRAINING FEES</h4>
            <p><em>Note: These fees can be paid in installments and will be communicated separately after application approval.</em></p>
            <ul>
              <li>Regular Cadre: ‚Ç¶95,000 (Complete uniform package)</li>
              <li>VIP Cadre: ‚Ç¶200,000 (Complete uniform package with additional benefits)</li>
            </ul>
            
            <h4>IMPORTANT NOTES</h4>
            <ul>
              <li>Application fee is non-refundable</li>
              <li>All payments are processed securely</li>
              <li>Organization reserves the right to reject any application</li>
              <li>False information will lead to disqualification</li>
              <li>By proceeding, you agree to all terms and conditions</li>
            </ul>
          </div>
        </div>
        
        <div class="scroll-indicator" id="termsScrollIndicator">
          Please scroll to the bottom to read and accept all terms
        </div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="agreeTerms" required>
          <label for="agreeTerms">
            I have read, understood, and agree to all Terms & Conditions of Marshal Core of Nigeria. 
            I confirm that I meet the necessary requirements for application.
          </label>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">
            ‚Üê Back to Home
          </button>
          <button type="button" class="btn btn-primary" id="proceedToCategoryBtn" onclick="proceedToCategory()">
            I Agree & Select Category ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Section 2: Category Selection -->
    <div class="section-container" id="section2">
      <div class="card">
        <h2>üéØ Select Your Category</h2>
        <p class="card-description">
          Choose the category that best fits your goals and aspirations. 
          Detailed information about fees and benefits will be provided after selection.
        </p>
        
        <div class="category-cards">
          <!-- Regular Category -->
          <div class="category-card" id="regularCategory" onclick="selectCategory('regular')">
            <div class="category-icon">üëÆ</div>
            <div class="category-title">Regular Cadre</div>
            <div class="category-description">
              For individuals aged 18+ seeking employment, skill acquisition, 
              career development in security services, and comprehensive training.
            </div>
            <div class="mt-20">
              <p><strong>Suitable For:</strong> Job seekers, fresh graduates, career changers</p>
              <p><strong>Training:</strong> 3-month comprehensive program</p>
              <p><strong>Benefits:</strong> Job placement, skill development, career support</p>
            </div>
            <button type="button" class="btn btn-primary mt-20" onclick="selectCategory('regular')">
              Select Regular Cadre
            </button>
          </div>
          
          <!-- VIP Category -->
          <div class="category-card" id="vipCategory" onclick="selectCategory('vip')">
            <div class="category-icon">üíº</div>
            <div class="category-title">VIP Cadre</div>
            <div class="category-description">
              For executives aged 25+ seeking security association status, 
              tech career pathway, business protection, and advanced training.
            </div>
            <div class="mt-20">
              <p><strong>Suitable For:</strong> Executives, business owners, professionals</p>
              <p><strong>Training:</strong> Advanced security & tech programs</p>
              <p><strong>Benefits:</strong> Tech career pathway, networking, business protection</p>
            </div>
            <button type="button" class="btn btn-primary mt-20" onclick="selectCategory('vip')">
              Select VIP Cadre
            </button>
          </div>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="goToSection(1)">
            ‚Üê Back to Terms
          </button>
          <button type="button" class="btn btn-primary" id="proceedToCheckBtn" onclick="proceedToCheckStatus()">
            Proceed to Check Status ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Section 3: Check Status / Continue Application -->
    <div class="section-container" id="section3">
      <div class="card">
        <h2>üîç Check Your Application Status</h2>
        <p class="card-description">
          Enter your details to check if you have an existing application. 
          If you've started before, you can continue from where you left off.
        </p>
        
        <form id="checkStatusForm">
          <div class="form-group">
            <label for="checkFullName">Full Name *</label>
            <input type="text" id="checkFullName" class="form-control" placeholder="Enter your full name" required>
          </div>
          
          <div class="form-group">
            <label for="checkEmail">Email Address *</label>
            <input type="email" id="checkEmail" class="form-control" placeholder="Enter your email address" required>
            <small class="file-info">We'll check if you have an existing application</small>
          </div>
          
          <div id="continueApplicationBox" class="continue-box" style="display: none;">
            <h4>üìã Existing Application Found!</h4>
            <div class="continue-status">
              <div class="status-item">
                <span class="status-label">Application Status:</span>
                <span class="status-value" id="appStatus">Not Available</span>
              </div>
              <div class="status-item">
                <span class="status-label">Current Stage:</span>
                <span class="status-value" id="currentStage">Not Available</span>
              </div>
              <div class="status-item">
                <span class="status-label">Last Updated:</span>
                <span class="status-value" id="lastUpdated">Not Available</span>
              </div>
              <div class="status-item">
                <span class="status-label">Password Status:</span>
                <span class="status-value" id="passwordStatus">Not Available</span>
              </div>
              <div class="status-item">
                <span class="status-label">Application Status:</span>
                <span class="status-value" id="formStatus">Not Available</span>
              </div>
            </div>
            <p class="mb-20">Click "Continue Application" to resume from where you left off.</p>
            <button type="button" class="btn btn-success btn-lg" id="continueAppBtn" onclick="continueApplication()">
              Continue Application ‚Üí
            </button>
          </div>
          
          <div id="startNewBox" class="continue-box" style="display: none; background: #e3f2fd; border-left-color: #2196f3;">
            <h4>üéâ Start New Application</h4>
            <p>No existing application found. You can start a new application process.</p>
            <button type="button" class="btn btn-primary btn-lg" onclick="startNewApplication()">
              Start New Application ‚Üí
            </button>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="goToSection(2)">
              ‚Üê Change Category
            </button>
            <button type="submit" class="btn btn-primary" id="checkStatusBtn">
              Check Application Status
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 4: Payment -->
    <div class="section-container" id="section4">
      <div class="card">
        <h2>üí≥ Complete Payment</h2>
        <p class="card-description">
          Secure payment for your application fee. After payment, you'll receive a password to continue.
        </p>
        
        <div class="payment-summary mb-30">
          <h3>Payment Summary</h3>
          <div class="form-group">
            <label>Selected Category</label>
            <input type="text" class="form-control" id="paymentCategory" readonly>
          </div>
          
          <div class="form-group">
            <label>Application Fee</label>
            <div class="payment-amount" id="paymentAmount">‚Ç¶0</div>
          </div>
          
          <div class="form-group">
            <label>Email for Payment</label>
            <input type="email" class="form-control" id="paymentEmail" readonly>
          </div>
        </div>
        
        <div class="terms-container">
          <div class="terms-content">
            <h4>Payment Information</h4>
            <ul>
              <li>This is the application fee only</li>
              <li>Uniform and training fees are separate and payable in installments</li>
              <li>Payment is processed securely via Paystack</li>
              <li>Application fee is non-refundable</li>
              <li>Receipt will be sent to your email</li>
              <li>After payment, you'll receive a password to complete your application</li>
            </ul>
          </div>
        </div>
        
        <div class="checkbox-container mb-30">
          <input type="checkbox" id="agreePayment" required>
          <label for="agreePayment">
            I agree to proceed with the payment and understand this is for the application fee only.
          </label>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="goToSection(3)">
            ‚Üê Back
          </button>
          <button type="button" class="btn btn-primary btn-lg" id="payNowBtn" onclick="initiatePayment()">
            Pay Now with Paystack
          </button>
        </div>
        
        <div class="text-center mt-20">
          <img src="https://paystack.com/assets/website/images/badges/verified-badge-with-border.png" alt="Paystack Verified" height="40">
          <p class="file-info">Secured by Paystack ‚Ä¢ PCI DSS Compliant</p>
        </div>
      </div>
    </div>

    <!-- Section 5: Password Entry -->
    <div class="section-container" id="section5">
      <div class="card">
        <h2>üîê Enter Your Password</h2>
        <p class="card-description">
          Enter the password sent to your email to continue with your application.
        </p>
        
        <form id="passwordForm">
          <div class="form-group">
            <label for="passwordEmail">Email Address</label>
            <input type="email" id="passwordEmail" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label for="password">Application Password *</label>
            <input type="password" id="password" class="form-control" placeholder="Enter the password sent to your email" required>
            <small class="file-info">Password is valid for 7 days ‚Ä¢ Check your email</small>
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="resendPassword()">
              Resend Password
            </button>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="goToSection(4)">
              ‚Üê Back to Payment
            </button>
            <button type="submit" class="btn btn-primary">
              Verify & Continue ‚Üí
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 6: Application Form -->
    <div class="section-container" id="section6">
      <div class="card">
        <h2>üìù Complete Your Application</h2>
        <p class="card-description">
          Fill in all required details. Passport photo is required. NIN details are optional.
        </p>
        
        <!-- Application Status Display -->
        <div id="applicationStatusDisplay" class="application-status" style="display: none;">
          <h3><i class="fas fa-info-circle"></i> Application Status</h3>
          <p id="statusMessageText"></p>
          <p><small>Last saved: <span id="lastSavedTime">Never</span></small></p>
        </div>
        
        <form id="applicationForm" enctype="multipart/form-data">
          <!-- Hidden Fields -->
          <input type="hidden" id="applicationPassword" name="application_password">
          <input type="hidden" id="applicationEmail" name="email">
          <input type="hidden" id="applicationTier" name="application_tier">
          <input type="hidden" id="preApplicantId" name="pre_applicant_id">
          
          <!-- Section A: Basic Information -->
          <h3>Section A: Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="formFullName">Full Name *</label>
              <input type="text" id="formFullName" name="full_name" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="phoneNumber">Phone Number *</label>
              <input type="tel" id="phoneNumber" name="phone_number" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="ninNumber">NIN Number <span class="optional-badge">Optional</span></label>
              <input type="text" id="ninNumber" name="nin_number" class="form-control" placeholder="Enter your NIN (optional)">
              <small class="file-info">National Identification Number (optional for initial application)</small>
            </div>
            
            <div class="form-group">
              <label for="dateOfBirth">Date of Birth *</label>
              <input type="date" id="dateOfBirth" name="date_of_birth" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="stateResidence">State of Residence *</label>
              <input type="text" id="stateResidence" name="state_of_residence" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="lga">Local Government Area *</label>
              <input type="text" id="lga" name="lga" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="address">Residential Address *</label>
              <textarea id="address" name="address" class="form-control" rows="3" required></textarea>
            </div>
          </div>
          
          <!-- Section B: Document Upload -->
          <h3>Section B: Document Upload</h3>
          
          <!-- Passport Photo Upload -->
          <div class="form-group">
            <label>Passport Photograph *</label>
            <div class="file-upload" id="passportUpload">
              <div class="upload-icon">üì∑</div>
              <p>Click to upload or drag and drop</p>
              <p class="file-info">JPG or PNG, max 2MB ‚Ä¢ Required for ID card</p>
              <input type="file" id="passportPhoto" name="passport_photo" class="file-input" accept="image/jpeg,image/png" required>
              <label for="passportPhoto" class="file-label">Choose Passport Photo</label>
            </div>
            <div class="file-preview" id="passportPreview"></div>
          </div>
          
          <!-- NIN Slip Upload (Optional) -->
          <div class="form-group">
            <label>NIN Slip <span class="optional-badge">Optional</span></label>
            <div class="file-upload" id="ninUpload">
              <div class="upload-icon">üìÑ</div>
              <p>Click to upload or drag and drop</p>
              <p class="file-info">PDF, JPG or PNG, max 5MB ‚Ä¢ Optional for initial application</p>
              <input type="file" id="ninSlip" name="nin_slip" class="file-input" accept=".pdf,image/jpeg,image/png">
              <label for="ninSlip" class="file-label">Choose NIN Slip (Optional)</label>
            </div>
            <div class="file-preview" id="ninPreview"></div>
          </div>
          
          <!-- Section C: Reasons for Joining -->
          <h3>Section C: Reasons for Joining</h3>
          <div id="reasonsSection"></div>
          
          <div class="form-group">
            <label for="additionalDetails">Additional Details (Optional)</label>
            <textarea id="additionalDetails" name="additional_details" class="form-control" rows="3" placeholder="Tell us more about your goals and aspirations..."></textarea>
          </div>
          
          <!-- Privacy Notice -->
          <h3>Privacy Notice Agreement</h3>
          <div class="terms-container" id="privacyTerms">
            <div class="terms-content">
              <h4>Privacy Notice - Must Read</h4>
              <p>MBC is an Executive Body under Article 6 Section B of the Constitution of Marshal Core of Nigeria, 2025 (as structured) that processes data in furtherance of our mandate as the sole statutory body empowered to appoint, promote, dismiss and exercise disciplinary control over all officers in the MARSHAL CORE OF NIGERIA (except the Director-General of Marshal core).</p>
              
              <p>We rely on lawful bases for data processing such as consent, substantial public interest, legal obligation and contract. We process various categories of your data so as to ensure that only suitably qualified Nigerians are recruited into the Marshal Core. Subject to your rights as a data subject, this Portal uses "cookies" which may help process your pattern of engagement and thereby create automated responses and notifications that seem most likely to suit your interest. This notice applies to the Marshal Board Committee.</p>
              
              <p>For queries about how we protect your data rights, please contact us:</p>
              <p>Email: info@marshalcoreofnigeria.ng</p>
            </div>
          </div>
          
          <div class="scroll-indicator" id="scrollIndicator">
            Please scroll to the bottom to read and accept
          </div>
          
          <div class="checkbox-container">
            <input type="checkbox" id="agreePrivacy" required>
            <label for="agreePrivacy">
              I have read, understood, and agree to the Privacy Notice and Terms & Conditions of Marshal Core Nigeria
            </label>
          </div>
          
          <!-- Submit Button -->
          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="goToSection(5)">
              ‚Üê Back
            </button>
            <button type="button" class="btn save-progress-btn" onclick="saveApplicationProgress()">
              <i class="fas fa-save"></i> Save Progress
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
              Submit Application & Generate PDF
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 7: Success Screen -->
    <div class="section-container" id="section7">
      <div class="card success-screen">
        <div class="success-icon">‚úì</div>
        <h1 class="success-title">Application Submitted Successfully!</h1>
        <p class="success-message">
          Your application has been processed. Check your email for the documents or download them below.
        </p>
        
        <div class="download-links">
          <div class="download-card" onclick="downloadPDF('application')">
            <div class="download-icon">üìã</div>
            <h3>Application Form PDF</h3>
            <p>Contains your complete application with passport photo</p>
            <button class="btn btn-primary btn-full mt-20">Download Application PDF</button>
          </div>
          
          <div class="download-card" onclick="downloadPDF('terms')">
            <div class="download-icon">üìú</div>
            <h3>Terms & Conditions PDF</h3>
            <p>Official terms document with your details</p>
            <button class="btn btn-primary btn-full mt-20">Download Terms PDF</button>
          </div>
          
          <div class="download-card" onclick="downloadGuarantorForm()">
            <div class="download-icon">üìù</div>
            <h3>Guarantor Form</h3>
            <p>Required for final application approval</p>
            <button class="btn btn-primary btn-full mt-20">Download Guarantor Form</button>
          </div>
        </div>
        
        <div id="emailLinkSection" class="mt-30" style="display: none;">
          <div class="alert alert-info">
            <h4><i class="fas fa-envelope"></i> Check Your Email</h4>
            <p>We've sent an email with download links to: <strong id="userEmailSent"></strong></p>
            <p>You can also use the direct links below:</p>
            <div class="text-center mt-20">
              <a href="#" id="directTermsLink" class="btn btn-secondary mr-2">Terms & Conditions</a>
              <a href="#" id="directAppLink" class="btn btn-secondary">Application Form</a>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="location.reload()">
            Start New Application
          </button>
          <button type="button" class="btn btn-primary" onclick="goToPortal()">
            Go to Applicant Portal ‚Üí
          </button>
        </div>
        
        <div class="contact-info mt-30">
          <p>Need help? Contact us at: support@marshalcoreofnigeria.ng</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <section class="footer_section">
    <div class="footer-content">
      <img src="images/logo.png" alt="Marshal Core Logo" class="footer-logo" onerror="this.onerror=null;this.src='images/logo.png';">
      <p class="contact-info">
        Marshal Core of Nigeria<br>
        Email: info@marshalcoreofnigeria.ng<br>
        Phone: +234 9137 428 031
      </p>
      <div class="copyright">
        Copyright &copy; 2025 All Rights Reserved By<br>
        Marshal Core of Nigeria<br>
        powered by MARSHAL BOARD COMMITTEE
      </div>
    </div>
  </section>

  <!-- Loader -->
  <div class="loader-overlay" id="loader">
    <div class="loader"></div>
    <div class="loader-text" id="loaderText">Processing...</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Global variables
    const API_BASE_URL = 'https://backend-mcn-ltd.onrender.com';
    let userData = {
      fullName: '',
      email: '',
      category: '',
      amount: 0,
      paymentReference: '',
      preApplicantId: '',
      applicantId: '',
      password: '',
      applicationStatus: null,
      savedProgress: null,
      isDraft: false
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Application initialized');
      console.log('üîó API Base URL:', API_BASE_URL);
      
      initializeApp();
      setupEventListeners();
      setupFileUploads();
      setupPrivacyScroll();
      setupTermsScroll();
      
      // Disable proceed button initially on terms page
      document.getElementById('proceedToCategoryBtn').disabled = true;
      document.getElementById('proceedToCheckBtn').disabled = true;
      
      // Check for saved application progress
      checkSavedProgress();
    });

    function initializeApp() {
      // Initialize the progress bar
      updateProgressBar(1);
      
      // Check for payment callback parameters
      handlePaymentCallback();
      
      // Check for direct download links
      handleDirectDownloadLinks();
    }

    function setupEventListeners() {
      // Terms checkbox
      const agreeTerms = document.getElementById('agreeTerms');
      const proceedToCategoryBtn = document.getElementById('proceedToCategoryBtn');
      
      if (agreeTerms && proceedToCategoryBtn) {
        agreeTerms.addEventListener('change', function() {
          proceedToCategoryBtn.disabled = !this.checked;
        });
      }

      // Check status form
      const checkStatusForm = document.getElementById('checkStatusForm');
      if (checkStatusForm) {
        checkStatusForm.addEventListener('submit', function(e) {
          e.preventDefault();
          checkApplicationStatus();
        });
      }

      // Password form
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
          e.preventDefault();
          handlePasswordVerification();
        });
      }
      
      // Application form
      const applicationForm = document.getElementById('applicationForm');
      if (applicationForm) {
        applicationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          handleApplicationSubmit();
        });
        
        // Auto-save on input change
        const inputs = applicationForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          input.addEventListener('change', function() {
            if (userData.email) {
              autoSaveProgress();
            }
          });
        });
      }
    }

    // Terms scroll check
    function setupTermsScroll() {
      const termsContainer = document.querySelector('.terms-container');
      const agreeTerms = document.getElementById('agreeTerms');
      const scrollIndicator = document.getElementById('termsScrollIndicator');
      
      if (termsContainer && agreeTerms && scrollIndicator) {
        termsContainer.addEventListener('scroll', function() {
          const scrollPercentage = (this.scrollTop + this.clientHeight) / this.scrollHeight;
          
          if (scrollPercentage > 0.95) {
            agreeTerms.disabled = false;
            scrollIndicator.style.display = 'none';
          } else {
            agreeTerms.disabled = true;
            scrollIndicator.style.display = 'block';
          }
        });
        
        // Initial check
        agreeTerms.disabled = true;
      }
    }

    // Progress and Navigation
    function goToSection(sectionNumber) {
      console.log(`üì± Navigating to section ${sectionNumber}`);
      
      // Hide all sections
      const sections = document.querySelectorAll('.section-container');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      // Show target section
      const targetSection = document.getElementById(`section${sectionNumber}`);
      if (targetSection) {
        targetSection.classList.add('active');
      } else {
        console.error(`Section ${sectionNumber} not found!`);
        return;
      }
      
      // Update progress bar
      updateProgressBar(sectionNumber);
      
      // Update steps
      const steps = document.querySelectorAll('.step');
      steps.forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNum = parseInt(step.getAttribute('data-step'));
        if (stepNum <= sectionNumber) {
          if (stepNum === sectionNumber) {
            step.classList.add('active');
          } else {
            step.classList.add('completed');
          }
        }
      });
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateProgressBar(currentStep) {
      const progressBar = document.getElementById('progressBar');
      if (!progressBar) return;
      
      const totalSteps = 5;
      const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
      progressBar.style.width = `${progressPercentage}%`;
    }

    // Section 1: Terms & Conditions
    function proceedToCategory() {
      const agreeTerms = document.getElementById('agreeTerms');
      
      if (!agreeTerms.checked) {
        showStatus('Please agree to the Terms & Conditions before proceeding', 'error');
        return;
      }
      
      goToSection(2);
    }

    // Section 2: Category Selection
    function selectCategory(category) {
      console.log(`üéØ Selected category: ${category}`);
      
      // Remove selected class from all categories
      document.getElementById('regularCategory').classList.remove('selected');
      document.getElementById('vipCategory').classList.remove('selected');
      
      // Add selected class to chosen category
      document.getElementById(`${category}Category`).classList.add('selected');
      
      // Store selected category and set amount
      userData.category = category;
      userData.amount = category === 'regular' ? 5180 : 25900;
      
      // Enable proceed button
      document.getElementById('proceedToCheckBtn').disabled = false;
    }

    function proceedToCheckStatus() {
      if (!userData.category) {
        showStatus('Please select a category first', 'error');
        return;
      }
      
      goToSection(3);
    }

    // Helper function to safely read response body - IMPROVED
    async function readBodySafely(res) {
      try {
        // First get the response text
        const text = await res.text();
        
        // If empty, return status info
        if (!text || text.trim() === '') {
          return {
            status: res.status,
            statusText: res.statusText,
            message: 'Empty response'
          };
        }
        
        // Try to parse as JSON
        try {
          const json = JSON.parse(text);
          // Add status info to JSON response
          if (typeof json === 'object' && !Array.isArray(json)) {
            json._status = res.status;
            json._statusText = res.statusText;
          }
          return json;
        } catch (jsonError) {
          // If not JSON, return text with status info
          return {
            status: res.status,
            statusText: res.statusText,
            message: text,
            raw: text
          };
        }
        
      } catch (e) {
        console.warn('Could not read response body:', e);
        return {
          status: 0,
          statusText: 'Read Error',
          message: 'Could not read response: ' + e.message,
          error: e.message
        };
      }
    }

    // Section 3: Check Application Status
    async function checkApplicationStatus() {
      const fullName = document.getElementById('checkFullName').value.trim();
      const email = document.getElementById('checkEmail').value.trim().toLowerCase();

      if (!fullName || !email) {
        showStatus('Please fill in all required fields', 'error');
        return;
      }

      if (!validateEmail(email)) {
        showStatus('Please enter a valid email address', 'error');
        return;
      }

      showLoader('Checking your application status...');

      try {
        // Use URLSearchParams for form data
        const formData = new URLSearchParams();
        formData.append('email', email);
        formData.append('full_name', fullName);
        formData.append('category', userData.category);

        console.log('üì§ Sending check-status request:', { 
          email, 
          full_name: fullName, 
          category: userData.category 
        });

        const response = await fetch(`${API_BASE_URL}/pre-applicant/check-status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: formData
        });

        console.log('üì• Response status:', response.status);

        if (!response.ok) {
          const body = await readBodySafely(response);
          console.log('‚ùå Error response body:', body);
          
          // If user doesn't exist, show start new option
          if (response.status === 404) {
            hideLoader();
            userData.fullName = fullName;
            userData.email = email;
            
            document.getElementById('continueApplicationBox').style.display = 'none';
            document.getElementById('startNewBox').style.display = 'block';
            return;
          }
          
          // Parse error message
          let errorDetail = 'Unknown error occurred';
          if (typeof body === 'object' && body !== null) {
            errorDetail = body.detail || body.message || JSON.stringify(body);
          } else if (typeof body === 'string') {
            try {
              const parsed = JSON.parse(body);
              errorDetail = parsed.detail || parsed.message || body;
            } catch {
              errorDetail = body;
            }
          }
          
          throw new Error(errorDetail);
        }

        // Parse successful response
        const data = await readBodySafely(response);
        console.log('‚úÖ Application status response:', data);

        // Store user data
        userData = { 
          ...userData, 
          fullName, 
          email,
          preApplicantId: data.pre_applicant_id || data.id,
          applicationStatus: data.status || data.current_stage,
          category: data.selected_tier || userData.category
        };

        hideLoader();
        
        // Update status display
        document.getElementById('appStatus').textContent = data.status || 'Active';
        document.getElementById('currentStage').textContent = data.current_stage || 'Pre-registration';
        document.getElementById('lastUpdated').textContent = data.last_updated || 'Today';
        document.getElementById('passwordStatus').textContent = data.password_sent ? 'Sent ‚úì' : 'Not Sent';
        document.getElementById('formStatus').textContent = data.application_submitted ? 'Submitted ‚úì' : 'Not Submitted';
        
        // Show continue box
        document.getElementById('continueApplicationBox').style.display = 'block';
        document.getElementById('startNewBox').style.display = 'none';

      } catch (error) {
        hideLoader();
        console.error('‚ùå Status check error:', error);
        
        // Show user-friendly error message
        let userMessage = error.message;
        if (error.message.includes('422')) {
          userMessage = 'Server validation error. Please ensure all fields are filled correctly.';
        } else if (error.message.includes('Failed to fetch')) {
          userMessage = 'Network error. Please check your internet connection.';
        }
        
        showStatus(`Error checking status: ${userMessage}`, 'error');
      }
    }

    function continueApplication() {
      if (!userData.preApplicantId) {
        showStatus('No application found to continue', 'error');
        return;
      }

      // Check the current stage and route accordingly
      const currentStage = userData.applicationStatus?.toLowerCase() || '';
      
      if (currentStage.includes('submitted')) {
        // Application already submitted
        showStatus('Application already submitted. Check your email for PDFs.', 'info');
        loadSubmittedApplication();
      } else if (currentStage.includes('payment') || currentStage.includes('tier')) {
        // Route to payment section
        setupPaymentSection();
        goToSection(4);
      } else if (currentStage.includes('password')) {
        // Route to password entry
        setupPasswordSection();
        goToSection(5);
      } else {
        // Default to payment section
        setupPaymentSection();
        goToSection(4);
      }
    }

    function startNewApplication() {
      // Register as new pre-applicant
      registerNewPreApplicant();
    }

    async function registerNewPreApplicant() {
      showLoader('Registering your application...');

      try {
        // Use URLSearchParams for form data
        const formData = new URLSearchParams();
        formData.append('full_name', userData.fullName);
        formData.append('email', userData.email);
        formData.append('tier', userData.category);

        console.log('üìù Registering pre-applicant:', { 
          full_name: userData.fullName, 
          email: userData.email, 
          tier: userData.category 
        });

        const response = await fetch(`${API_BASE_URL}/pre-applicant/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: formData
        });

        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || body.message || JSON.stringify(body)) : body;
          throw new Error(`Registration failed: ${errorMsg}`);
        }

        const data = await readBodySafely(response);
        console.log('‚úÖ Pre-registration response:', data);

        userData.preApplicantId = data.pre_applicant_id || data.id;

        hideLoader();
        showStatus('Registration successful! Proceeding to payment.', 'success');
        
        // Setup payment section and go to payment
        setupPaymentSection();
        goToSection(4);

      } catch (error) {
        hideLoader();
        console.error('‚ùå Registration error:', error);
        showStatus(`Registration failed: ${error.message}`, 'error');
      }
    }

    function setupPaymentSection() {
      const categoryName = userData.category === 'regular' ? 'Regular Cadre' : 'VIP Cadre';
      document.getElementById('paymentCategory').value = categoryName;
      document.getElementById('paymentAmount').textContent = `‚Ç¶${userData.amount.toLocaleString()}`;
      document.getElementById('paymentEmail').value = userData.email;
    }

    // Section 4: Payment - CORRECTED VERSION (FIXED 422 ERROR)
    async function initiatePayment() {
      if (!document.getElementById('agreePayment').checked) {
        showStatus('Please agree to the payment terms', 'error');
        return;
      }
      
      showLoader('Initializing payment...');
      
      try {
        // First, ensure tier is selected
        console.log('üéØ User data before payment:', userData);
        
        // If preApplicantId is not set, get it from backend
        if (!userData.preApplicantId) {
          console.log('üîç Getting pre-applicant ID...');
          const statusResponse = await fetch(`${API_BASE_URL}/pre-applicant/status/${encodeURIComponent(userData.email)}`);
          if (statusResponse.ok) {
            const statusData = await statusResponse.json();
            userData.preApplicantId = statusData.pre_applicant_id || statusData.id;
          }
        }
        
        // Select tier in backend (ensure it's selected)
        const tierFormData = new URLSearchParams();
        tierFormData.append('email', userData.email);
        tierFormData.append('tier', userData.category);
        
        console.log('üéØ Selecting tier with:', { email: userData.email, tier: userData.category });
        
        const tierResponse = await fetch(`${API_BASE_URL}/pre-applicant/select-tier`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: tierFormData
        });
        
        if (!tierResponse.ok) {
          const body = await readBodySafely(tierResponse);
          console.log('‚ùå Tier selection error:', body);
          const errorMsg = typeof body === 'object' ? (body.detail || body.message || JSON.stringify(body)) : body;
          throw new Error(`Tier selection failed: ${errorMsg}`);
        }
        
        const tierData = await readBodySafely(tierResponse);
        console.log('‚úÖ Tier selection response:', tierData);
        
        // PAYMENT INITIATION - FIXED PARAMETERS
        console.log('üí∞ Initiating payment with parameters:', {
          email: userData.email,
          tier: userData.category,
          amount: userData.amount,
          pre_applicant_id: userData.preApplicantId,
          payment_type: userData.category,
          user_type: 'pre_applicant'
        });
        
        // Try different parameter combinations - FIXED
        const paymentParams = new URLSearchParams();
        
        // Minimum required parameters based on common payment endpoints
        paymentParams.append('email', userData.email);
        paymentParams.append('amount', userData.amount.toString());
        paymentParams.append('payment_type', userData.category);
        paymentParams.append('user_type', 'pre_applicant');
        
        // Add optional but helpful parameters
        if (userData.preApplicantId) {
          paymentParams.append('pre_applicant_id', userData.preApplicantId);
        }
        
        // Some endpoints use 'tier' instead of 'payment_type'
        paymentParams.append('tier', userData.category);
        
        // Add full name for reference
        paymentParams.append('full_name', userData.fullName);
        
        console.log('üí∞ Sending payment request with params:', Object.fromEntries(paymentParams));
        
        const paymentResponse = await fetch(`${API_BASE_URL}/api/payments/initiate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: paymentParams
        });
        
        console.log('üí∞ Payment response status:', paymentResponse.status);
        
        if (!paymentResponse.ok) {
          const body = await readBodySafely(paymentResponse);
          console.log('üí∞ Payment error body (raw):', body);
          
          // Try to parse error properly
          let errorDetail = 'Payment initiation failed';
          
          if (body && typeof body === 'object') {
            // Handle object error
            if (body.detail) {
              errorDetail = body.detail;
            } else if (body.message) {
              errorDetail = body.message;
            } else if (body.error) {
              errorDetail = body.error;
            } else {
              // Try to stringify the object for display
              try {
                errorDetail = JSON.stringify(body);
              } catch {
                errorDetail = 'Unknown payment error';
              }
            }
          } else if (typeof body === 'string') {
            // Handle string error
            try {
              const parsed = JSON.parse(body);
              errorDetail = parsed.detail || parsed.message || parsed.error || body;
            } catch {
              errorDetail = body;
            }
          }
          
          console.log('üí∞ Parsed error detail:', errorDetail);
          
          // Check if payment already completed
          if (errorDetail.includes('already_paid') || errorDetail.includes('already paid')) {
            hideLoader();
            showStatus('Payment already completed. Generating password...', 'info');
            await generatePassword(userData.email, userData.fullName);
            return;
          }
          
          // Try alternative endpoint or method
          if (paymentResponse.status === 422) {
            console.log('üîÑ Trying alternative payment method...');
            
            // Try with JSON instead of form data
            const jsonBody = {
              email: userData.email,
              amount: userData.amount,
              payment_type: userData.category,
              user_type: 'pre_applicant',
              pre_applicant_id: userData.preApplicantId,
              tier: userData.category,
              full_name: userData.fullName
            };
            
            console.log('üîÑ Trying JSON request:', jsonBody);
            
            const jsonResponse = await fetch(`${API_BASE_URL}/api/payments/initiate`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(jsonBody)
            });
            
            if (jsonResponse.ok) {
              const paymentData = await readBodySafely(jsonResponse);
              console.log('‚úÖ Payment initiation (JSON) response:', paymentData);
              userData.paymentReference = paymentData.payment_reference || paymentData.reference || paymentData.data?.reference;
              await openPaystack(userData.paymentReference);
              return;
            } else {
              const jsonError = await readBodySafely(jsonResponse);
              console.log('‚ùå JSON payment also failed:', jsonError);
            }
          }
          
          throw new Error(errorDetail);
        }
        
        const paymentData = await readBodySafely(paymentResponse);
        console.log('‚úÖ Payment initiation response:', paymentData);
        
        userData.paymentReference = paymentData.payment_reference || paymentData.reference || paymentData.data?.reference;
        
        // Open Paystack payment
        await openPaystack(userData.paymentReference);
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Payment initiation error:', error);
        
        // Show proper error message
        let userMessage = error.message;
        if (error.message.includes('422')) {
          userMessage = 'Payment validation error. Required parameters missing.';
        } else if (error.message.includes('Failed to fetch')) {
          userMessage = 'Network error. Please check your connection.';
        } else if (error.message.includes('already_paid')) {
          userMessage = 'Payment already completed. Please check your email.';
        } else if (error.message.includes('[object Object]')) {
          userMessage = 'Payment server error. Please try again or contact support.';
        }
        
        showStatus(`Payment failed: ${userMessage}`, 'error');
      }
    }

    // Helper function to open Paystack
    async function openPaystack(paymentReference) {
      if (typeof PaystackPop === 'undefined') {
        throw new Error('Paystack script not loaded');
      }
      
      hideLoader();
      
      const handler = PaystackPop.setup({
        key: 'pk_test_c6ff4f4622c7e35eb557e9e3be0c7424b5d0a3d4',
        email: userData.email,
        amount: userData.amount * 100,
        currency: 'NGN',
        ref: paymentReference,
        metadata: {
          full_name: userData.fullName,
          tier: userData.category,
          pre_applicant_id: userData.preApplicantId,
          email: userData.email
        },
        callback: function(response) {
          console.log('üí∞ Payment callback:', response);
          verifyPayment(response.reference);
        },
        onClose: function() {
          showStatus('Payment window closed. You can try again.', 'warning');
        }
      });
      
      handler.openIframe();
    }

    async function verifyPayment(reference) {
      showLoader('Verifying payment...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/payments/verify/${reference}`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üîç Payment verification status:', response.status);
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          console.log('üîç Payment verification error body:', body);
          
          let errorMsg = 'Payment verification failed';
          if (typeof body === 'object' && body !== null) {
            errorMsg = body.detail || body.message || JSON.stringify(body);
          } else if (typeof body === 'string') {
            errorMsg = body;
          }
          
          // If payment verification fails but we have reference, still try to generate password
          if (reference) {
            console.log('‚ö†Ô∏è Payment verification failed, but trying to generate password anyway');
            hideLoader();
            showStatus('Payment may have been successful. Generating password...', 'warning');
            await generatePassword(userData.email, userData.fullName);
            return;
          }
          
          throw new Error(errorMsg);
        }
        
        const data = await readBodySafely(response);
        console.log('‚úÖ Payment verification response:', data);
        
        // ‚úÖ CRITICAL FIX: Get the correct pre-applicant ID after payment
        await getCorrectPreApplicantId();
        
        // Payment verified, generate password
        await generatePassword(userData.email, userData.fullName);
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Payment verification error:', error);
        
        // Still try to generate password if we have a reference
        if (userData.paymentReference) {
          showStatus('Payment may have been successful. Attempting to generate password...', 'warning');
          await generatePassword(userData.email, userData.fullName);
        } else {
          showStatus(`Verification failed: ${error.message}`, 'error');
        }
      }
    }

    // ‚úÖ FIXED: Get correct pre-applicant ID from backend
async function getCorrectPreApplicantId() {
    try {
        console.log('üîÑ Getting correct pre-applicant ID for:', userData.email);
        
        const response = await fetch(`${API_BASE_URL}/pre-applicant/status/${encodeURIComponent(userData.email)}`);
        
        if (response.ok) {
            const data = await readBodySafely(response);
            console.log('‚úÖ Current pre-applicant status:', data);
            
            // ‚úÖ FIXED: Try multiple possible field names
            let newPreApplicantId = data.pre_applicant_id || data.id || data.pre_applicant_data?.id;
            
            // Validate it's not 'undefined' string
            if (newPreApplicantId && newPreApplicantId !== 'undefined' && newPreApplicantId !== 'null') {
                const oldId = userData.preApplicantId;
                userData.preApplicantId = newPreApplicantId;
                
                // Also store in localStorage
                localStorage.setItem('preApplicantId', userData.preApplicantId);
                
                console.log(`‚úÖ Updated preApplicantId: ${oldId} ‚Üí ${userData.preApplicantId}`);
                
                // Update the hidden field in the form
                document.getElementById('preApplicantId').value = userData.preApplicantId;
                
                return userData.preApplicantId;
            } else {
                console.warn('‚ö†Ô∏è No valid pre-applicant ID in response, checking localStorage');
                
                // Check localStorage as fallback
                const storedId = localStorage.getItem('preApplicantId');
                if (storedId && storedId !== 'undefined') {
                    userData.preApplicantId = storedId;
                    document.getElementById('preApplicantId').value = userData.preApplicantId;
                    console.log('‚úÖ Using preApplicantId from localStorage:', userData.preApplicantId);
                    return userData.preApplicantId;
                }
            }
        } else {
            console.warn('‚ö†Ô∏è Could not get pre-applicant status, using existing ID:', userData.preApplicantId);
        }
        
        return userData.preApplicantId;
    } catch (error) {
        console.error('‚ùå Error getting correct pre-applicant ID:', error);
        return userData.preApplicantId;
    }
  }

    async function generatePassword(email, fullName) {
      showLoader('Generating application password...');

      try {
        // Use JSON instead of form data - backend expects JSON
        const jsonBody = {
          email: email
        };

        console.log('üîë Generating password for:', email);
        
        const response = await fetch(`${API_BASE_URL}/access/generate-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(jsonBody)
        });

        console.log('üîë Password generation status:', response.status);
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          console.log('üîë Password generation error body:', body);
          
          // If 422, try with form data as fallback
          if (response.status === 422) {
            console.log('üîÑ Trying form data format for password generation...');
            const formData = new URLSearchParams();
            formData.append('email', email);
            
            const formResponse = await fetch(`${API_BASE_URL}/access/generate-password`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
              },
              body: formData
            });
            
            if (formResponse.ok) {
              const formDataResponse = await readBodySafely(formResponse);
              console.log('‚úÖ Password generation (form) response:', formDataResponse);
              hideLoader();
              showStatus('‚úÖ Password generated and sent to your email!', 'success');
              setupPasswordSection();
              goToSection(5);
              return;
            }
          }
          
          const errorMsg = typeof body === 'object' ? (body.detail || body.message || JSON.stringify(body)) : body;
          throw new Error(`Password generation failed: ${errorMsg}`);
        }

        const data = await readBodySafely(response);
        console.log('‚úÖ Password generation response:', data);

        hideLoader();
        showStatus('‚úÖ Password generated and sent to your email!', 'success');

        // Setup password section
        setupPasswordSection();
        goToSection(5);

      } catch (error) {
        hideLoader();
        console.error('‚ùå Password generation error:', error);
        
        // Still proceed to password section if payment was made
        showStatus(`Password generation may have issues: ${error.message}. Please check your email or use "Resend Password".`, 'warning');
        setupPasswordSection();
        goToSection(5);
      }
    }

    function setupPasswordSection() {
      document.getElementById('passwordEmail').value = userData.email;
    }

    async function resendPassword() {
      showLoader('Resending password...');

      try {
        // Use JSON format
        const jsonBody = {
          email: userData.email
        };

        const response = await fetch(`${API_BASE_URL}/access/generate-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(jsonBody)
        });

        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || body.message || JSON.stringify(body)) : body;
          throw new Error(`Failed to resend password: ${errorMsg}`);
        }

        hideLoader();
        showStatus('‚úÖ Password resent to your email!', 'success');

      } catch (error) {
        hideLoader();
        console.error('‚ùå Resend password error:', error);
        showStatus(`Failed to resend password: ${error.message}`, 'error');
      }
    }

    // Section 5: Password Verification - FIXED VERSION
    async function handlePasswordVerification() {
      const password = document.getElementById('password').value.trim();
      const email = document.getElementById('passwordEmail').value.trim();
      
      if (!email || !password) {
        showStatus('Both email and password are required', 'error');
        return;
      }
      
      showLoader('Verifying password...');
      
      try {
        // First try JSON format (backend seems to prefer this)
        const jsonBody = {
          email: email,
          password: password
        };

        console.log('üîê Verifying password for:', email);
        
        const response = await fetch(`${API_BASE_URL}/access/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(jsonBody)
        });
        
        console.log('üîê Password verification status:', response.status);
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          console.log('üîê Password verification error body:', body);
          
          // If 422, try form data as fallback
          if (response.status === 422) {
            console.log('üîÑ Trying form data for password verification...');
            const formData = new URLSearchParams();
            formData.append('email', email);
            formData.append('password', password);
            
            const formResponse = await fetch(`${API_BASE_URL}/access/verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
              },
              body: formData
            });
            
            if (formResponse.ok) {
              const formDataResponse = await readBodySafely(formResponse);
              console.log('‚úÖ Password verification (form) response:', formDataResponse);
              
              // ‚úÖ CRITICAL FIX: Get correct pre-applicant ID
              await getCorrectPreApplicantId();
              
              // Store verified password
              userData.password = password;
              
              // Accept privacy notice
              await acceptPrivacyNotice();
              
              // Load application form
              loadApplicationForm();
              
              hideLoader();
              showStatus('‚úÖ Password verified successfully!', 'success');
              goToSection(6);
              return;
            }
          }
          
          // Parse error properly
          let errorDetail = 'Password verification failed';
          if (body && typeof body === 'object') {
            if (body.detail) {
              errorDetail = body.detail;
            } else if (body.message) {
              errorDetail = body.message;
            } else if (Array.isArray(body) && body.length > 0) {
              errorDetail = body[0].msg || JSON.stringify(body);
            } else {
              errorDetail = JSON.stringify(body);
            }
          } else if (typeof body === 'string') {
            try {
              const parsed = JSON.parse(body);
              errorDetail = parsed.detail || parsed.message || parsed.error || body;
            } catch {
              errorDetail = body;
            }
          }
          
          throw new Error(errorDetail);
        }
        
        const data = await readBodySafely(response);
        console.log('‚úÖ Password verification response:', data);
        
        // ‚úÖ CRITICAL FIX: Get correct pre-applicant ID
        await getCorrectPreApplicantId();
        
        // Store verified password
        userData.password = password;
        
        // Accept privacy notice
        await acceptPrivacyNotice();
        
        // Load application form
        loadApplicationForm();
        
        hideLoader();
        showStatus('‚úÖ Password verified successfully!', 'success');
        goToSection(6);
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Password verification error:', error);
        
        // Show better error message
        let userMessage = error.message;
        if (error.message.includes('[object Object]')) {
          userMessage = 'Invalid password format. Please check the password sent to your email.';
        } else if (error.message.includes('Invalid') || error.message.includes('incorrect')) {
          userMessage = 'Incorrect password. Please check your email and try again.';
        } else if (error.message.includes('Failed to fetch')) {
          userMessage = 'Network error. Please check your connection.';
        }
        
        showStatus(`Verification failed: ${userMessage}`, 'error');
      }
    }

    async function acceptPrivacyNotice() {
      try {
        // Use JSON format
        const jsonBody = {
          email: userData.email
        };

        const response = await fetch(`${API_BASE_URL}/privacy/accept`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(jsonBody)
        });
        
        if (!response.ok) {
          console.warn('‚ö†Ô∏è Privacy acceptance failed');
        } else {
          console.log('‚úÖ Privacy notice accepted');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Privacy acceptance error:', error);
      }
    }

    function loadApplicationForm() {
      // Pre-fill form with user data
      document.getElementById('formFullName').value = userData.fullName;
      document.getElementById('applicationEmail').value = userData.email;
      document.getElementById('applicationPassword').value = userData.password;
      document.getElementById('applicationTier').value = userData.category;
      document.getElementById('preApplicantId').value = userData.preApplicantId;
      
      // Load reasons for joining based on category
      const reasonsSection = document.getElementById('reasonsSection');
      reasonsSection.innerHTML = '';
      
      if (userData.category === 'regular') {
        reasonsSection.innerHTML = `
          <div class="form-group">
            <label>Select reasons for joining (choose up to 3):</label>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="seeking_employment" id="reason1">
              <label for="reason1">Seeking Employment & Work</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="skill_acquisition" id="reason2">
              <label for="reason2">Skill Acquisition & Handwork Training</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="armed_forces" id="reason3">
              <label for="reason3">Armed Forces Preparation</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="personal_development" id="reason4">
              <label for="reason4">Personal Development & Discipline</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="ict_knowledge" id="reason5">
              <label for="reason5">ICT Knowledge & Basic Computer Skills</label>
            </div>
            <small class="file-info">Select 1-3 options only</small>
          </div>
        `;
      } else {
        reasonsSection.innerHTML = `
          <div class="form-group">
            <label>Select reasons for joining (choose all that apply):</label>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="security_association" id="reason6">
              <label for="reason6">Security Association & Legal Protection</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="tech_career" id="reason7">
              <label for="reason7">Tech Career Pathway (Full SXTM Training)</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="networking" id="reason8">
              <label for="reason8">Networking & Professional Status Enhancement</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="security_awareness" id="reason9">
              <label for="reason9">Security Awareness & Risk Management</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="business_protection" id="reason10">
              <label for="reason10">Business Protection & Organizational Backup</label>
            </div>
          </div>
        `;
      }
      
      // Check for saved progress
      checkSavedProgress();
    }

    // Save application progress
    async function saveApplicationProgress() {
      showLoader('Saving your progress...');
      
      try {
        const formData = collectFormData();
        
        // Save to localStorage for offline access
        localStorage.setItem(`marshal_app_${userData.email}`, JSON.stringify({
          data: formData,
          timestamp: new Date().toISOString(),
          tier: userData.category,
          email: userData.email
        }));
        
        // Also save to backend if user is authenticated
        if (userData.password) {
          const jsonBody = {
            email: userData.email,
            form_data: formData,
            is_draft: true
          };
          
          const response = await fetch(`${API_BASE_URL}/save-progress`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(jsonBody)
          });
          
          if (response.ok) {
            console.log('‚úÖ Progress saved to backend');
          }
        }
        
        hideLoader();
        showStatus('‚úÖ Application progress saved successfully! You can continue later.', 'success');
        
        // Update status display
        updateProgressStatus('saved', 'Progress saved');
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Error saving progress:', error);
        showStatus('‚ö†Ô∏è Progress saved locally. You can continue from here later.', 'warning');
      }
    }

    function autoSaveProgress() {
      if (userData.email) {
        const formData = collectFormData();
        localStorage.setItem(`marshal_app_${userData.email}`, JSON.stringify({
          data: formData,
          timestamp: new Date().toISOString(),
          tier: userData.category,
          email: userData.email
        }));
        console.log('üíæ Auto-saved progress');
      }
    }

    function checkSavedProgress() {
      if (userData.email) {
        const saved = localStorage.getItem(`marshal_app_${userData.email}`);
        if (saved) {
          try {
            const savedData = JSON.parse(saved);
            userData.savedProgress = savedData;
            
            // Restore form data
            restoreFormData(savedData.data);
            
            // Show status
            updateProgressStatus('saved', `Progress saved on ${new Date(savedData.timestamp).toLocaleDateString()}`);
            
          } catch (e) {
            console.warn('Could not restore saved progress:', e);
          }
        }
      }
    }

    function collectFormData() {
      const form = document.getElementById('applicationForm');
      const data = {};
      
      // Collect all form fields
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
          data[input.name] = input.checked;
        } else {
          data[input.name] = input.value;
        }
      });
      
      // Collect file info
      const passportFile = document.getElementById('passportPhoto').files[0];
      if (passportFile) {
        data.passportFileName = passportFile.name;
        data.passportFileSize = passportFile.size;
        data.passportFileType = passportFile.type;
      }
      
      const ninFile = document.getElementById('ninSlip').files[0];
      if (ninFile) {
        data.ninFileName = ninFile.name;
        data.ninFileSize = ninFile.size;
        data.ninFileType = ninFile.type;
      }
      
      // Collect selected reasons
      const selectedReasons = [];
      document.querySelectorAll('input[name="selected_reasons"]:checked').forEach(checkbox => {
        selectedReasons.push(checkbox.value);
      });
      data.selected_reasons = selectedReasons;
      
      return data;
    }

    function restoreFormData(data) {
      if (!data) return;
      
      const form = document.getElementById('applicationForm');
      
      // Restore text fields
      Object.keys(data).forEach(key => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
          if (input.type === 'checkbox' || input.type === 'radio') {
            input.checked = data[key];
          } else if (input.type !== 'file') {
            input.value = data[key] || '';
          }
        }
      });
      
      // Restore reasons checkboxes
      if (data.selected_reasons && Array.isArray(data.selected_reasons)) {
        data.selected_reasons.forEach(reason => {
          const checkbox = document.querySelector(`input[value="${reason}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
      
      // Update file previews if files were saved
      if (data.passportFileName) {
        updateFilePreview('passportPreview', data.passportFileName, data.passportFileSize);
      }
      
      if (data.ninFileName) {
        updateFilePreview('ninPreview', data.ninFileName, data.ninFileSize);
      }
    }

    function updateProgressStatus(status, message) {
      const statusDisplay = document.getElementById('applicationStatusDisplay');
      const statusMessage = document.getElementById('statusMessageText');
      const lastSavedTime = document.getElementById('lastSavedTime');
      
      if (statusDisplay && statusMessage && lastSavedTime) {
        statusDisplay.style.display = 'block';
        statusMessage.textContent = message;
        lastSavedTime.textContent = new Date().toLocaleString();
        
        // Update badge color
        const badge = statusDisplay.querySelector('.status-badge');
        if (badge) {
          badge.className = `status-badge ${status}`;
          badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
      }
    }

    // Handle application submission - FIXED VERSION
    async function handleApplicationSubmit() {
      // Validate passport upload
      const passportFile = document.getElementById('passportPhoto').files[0];
      if (!passportFile) {
        showStatus('Passport photo is required', 'error');
        return;
      }
      
      // Validate file types and sizes
      if (passportFile.size > 2 * 1024 * 1024) {
        showStatus('Passport photo must be less than 2MB', 'error');
        return;
      }
      
      if (!['image/jpeg', 'image/png'].includes(passportFile.type)) {
        showStatus('Passport must be JPG or PNG format', 'error');
        return;
      }
      
      showLoader('Submitting application and generating PDFs...');
      
      try {
        // Collect form data - Use FormData for multipart/form-data
        const formData = new FormData(document.getElementById('applicationForm'));
        
        // Get selected reasons
        const selectedReasons = [];
        document.querySelectorAll('input[name="selected_reasons"]:checked').forEach(checkbox => {
          selectedReasons.push(checkbox.value);
        });
        
        if (selectedReasons.length === 0) {
          throw new Error('Please select at least one reason for joining');
        }
        
        if (userData.category === 'regular' && selectedReasons.length > 3) {
          throw new Error('Regular applicants can select up to 3 reasons only');
        }
        
        formData.set('selected_reasons', JSON.stringify(selectedReasons));
        
        // ‚úÖ FIX: Use the correct pre-applicant ID
        console.log('üîë Using preApplicantId:', userData.preApplicantId);
        formData.append('application_password', userData.password);
        formData.append('email', userData.email);
        formData.append('application_tier', userData.category);
        formData.append('pre_applicant_id', userData.preApplicantId);
        
        // ‚úÖ Add payment reference if available
        if (userData.paymentReference) {
          formData.append('payment_reference', userData.paymentReference);
          formData.append('amount_paid', userData.amount.toString());
        }
        
        console.log('üì§ Submitting application with:', {
          email: userData.email,
          tier: userData.category,
          pre_applicant_id: userData.preApplicantId,
          payment_reference: userData.paymentReference,
          amount: userData.amount
        });
        
        const response = await fetch(`${API_BASE_URL}/apply`, {
          method: 'POST',
          body: formData
        });
        
        console.log('üì• Submission response status:', response.status);
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          console.log('‚ùå Submission error body:', body);
          
          // Handle specific errors
          let errorMsg = 'Application submission failed';
          if (body && typeof body === 'object') {
            errorMsg = body.detail || body.message || JSON.stringify(body);
          } else if (typeof body === 'string') {
            errorMsg = body;
          }
          
          // Special handling for authentication errors
          if (errorMsg.includes('Invalid application credentials') || 
              errorMsg.includes('application_password') ||
              errorMsg.includes('authentication')) {
            errorMsg = 'Authentication failed. Please verify your password and try again.';
          }
          
          throw new Error(errorMsg);
        }
        
        const data = await readBodySafely(response);
        console.log('‚úÖ Application submission response:', data);
        
        // Store applicant ID for PDF downloads
        userData.applicantId = data.id || data.applicant_id;
        
        hideLoader();
        showStatus('‚úÖ Application submitted successfully! PDFs are being generated and will be emailed to you.', 'success');
        
        // Clear saved progress
        if (userData.email) {
          localStorage.removeItem(`marshal_app_${userData.email}`);
        }
        
        // Move to success screen
        goToSection(7);
        
        // Show email section with PDF download links
        showEmailSuccessSection(data);
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Application submission error:', error);
        showStatus(`Submission failed: ${error.message}`, 'error');
      }
    }

    function showEmailSuccessSection(data) {
      document.getElementById('userEmailSent').textContent = userData.email;
      document.getElementById('emailLinkSection').style.display = 'block';
      
      // Generate direct download links
      const baseUrl = `${API_BASE_URL}`;
      
      // Applicant PDF links
      if (data.terms_pdf_path) {
        document.getElementById('directTermsLink').href = `${baseUrl}/${data.terms_pdf_path}`;
        document.getElementById('directTermsLink').download = `Marshal_Core_Terms_${userData.applicantId}.pdf`;
      }
      
      if (data.application_pdf_path) {
        document.getElementById('directAppLink').href = `${baseUrl}/${data.application_pdf_path}`;
        document.getElementById('directAppLink').download = `Marshal_Core_Application_${userData.applicantId}.pdf`;
      }
      
      // Add guarantor form link
      const guarantorLink = document.createElement('a');
      guarantorLink.href = `${baseUrl}/static/pdfs/guarantor_form.pdf`;
      guarantorLink.className = 'btn btn-secondary ml-2';
      guarantorLink.download = 'Marshal_Core_Guarantor_Form.pdf';
      guarantorLink.textContent = 'Guarantor Form';
      document.querySelector('#emailLinkSection .text-center').appendChild(guarantorLink);
    }

    // Section 7: PDF Downloads
    async function downloadPDF(type) {
      if (!userData.applicantId) {
        showStatus('Applicant ID not found. Please contact support.', 'error');
        return;
      }
      
      showLoader(`Generating ${type} PDF...`);
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/pdf/${type}/${userData.applicantId}?user_type=applicant`,
          {
            method: 'GET'
          }
        );
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || body.message || JSON.stringify(body)) : body;
          throw new Error(`PDF generation failed: ${errorMsg}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `marshal_core_${type}_${userData.applicantId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoader();
        showStatus(`${type === 'application' ? 'Application' : 'Terms'} PDF downloaded successfully!`, 'success');
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå PDF download error:', error);
        showStatus(`Failed to download PDF: ${error.message}`, 'error');
      }
    }

    async function downloadGuarantorForm() {
      showLoader('Downloading Guarantor Form...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/static/pdfs/guarantor_form.pdf`, {
          method: 'GET'
        });
        
        if (!response.ok) {
          throw new Error('Guarantor form not found');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Marshal_Core_Guarantor_Form.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoader();
        showStatus('Guarantor form downloaded successfully!', 'success');
        
      } catch (error) {
        hideLoader();
        console.error('‚ùå Guarantor form download error:', error);
        showStatus(`Failed to download guarantor form: ${error.message}`, 'error');
      }
    }

    function goToPortal() {
      window.location.href = 'https://marshalcoreofnigeria.ng/portal';
    }

    // Handle direct download links from email
    function handleDirectDownloadLinks() {
      const urlParams = new URLSearchParams(window.location.search);
      const downloadType = urlParams.get('download');
      const userId = urlParams.get('user_id');
      const userType = urlParams.get('user_type') || 'applicant';
      const token = urlParams.get('token');
      
      if (downloadType && userId) {
        showLoader('Preparing download...');
        
        // Validate token if provided
        if (token) {
          // In production, verify token with backend
          console.log('üîê Token verification needed');
        }
        
        // Direct download
        setTimeout(() => {
          const downloadUrl = `${API_BASE_URL}/pdf/${downloadType}/${userId}?user_type=${userType}&token=${token || ''}`;
          window.location.href = downloadUrl;
        }, 1000);
      }
    }

    function loadSubmittedApplication() {
      // This would load an already submitted application
      showLoader('Loading your submitted application...');
      
      setTimeout(() => {
        hideLoader();
        showStatus('Your application was already submitted. Check your email for download links.', 'info');
        goToSection(7);
      }, 1500);
    }

    // Utility functions
    function showLoader(text = 'Processing...') {
      document.getElementById('loaderText').textContent = text;
      document.getElementById('loader').style.display = 'flex';
    }

    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      
      // Handle object messages
      if (typeof message === 'object') {
        try {
          // Try to extract meaningful error message
          if (message.detail) {
            message = message.detail;
          } else if (message.message) {
            message = message.message;
          } else if (message.error) {
            message = message.error;
          } else if (Array.isArray(message) && message.length > 0) {
            // Handle array errors (like validation errors)
            message = message.map(item => item.msg || JSON.stringify(item)).join(', ');
          } else {
            // Stringify the object
            message = JSON.stringify(message);
          }
        } catch {
          message = 'An error occurred';
        }
      }
      
      statusDiv.textContent = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds for non-error messages
      if (type !== 'error') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Handle Paystack callback
    function handlePaymentCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const reference = urlParams.get('reference');
      const trxref = urlParams.get('trxref');
      
      if (reference || trxref) {
        showLoader('Verifying payment...');
        verifyPayment(reference || trxref);
      }
    }

    // File Upload Functions
    function setupFileUploads() {
      setupFileUpload('passportUpload', 'passportPhoto', 'passportPreview', true);
      setupFileUpload('ninUpload', 'ninSlip', 'ninPreview', false);
    }

    function setupFileUpload(dropZoneId, fileInputId, previewId, isImage) {
      const dropZone = document.getElementById(dropZoneId);
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewId);
      
      if (!dropZone || !fileInput || !preview) return;
      
      dropZone.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', function() {
        handleFileSelect(this.files[0], preview, isImage);
      });
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropZone.classList.add('dragover');
      }
      
      function unhighlight() {
        dropZone.classList.remove('dragover');
      }
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      dropZone.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFileSelect(files[0], preview, isImage);
      });
    }

    function handleFileSelect(file, previewContainer, isImage) {
      if (!file) return;
      
      previewContainer.innerHTML = '';
      previewContainer.style.display = 'block';
      
      const previewDiv = document.createElement('div');
      previewDiv.className = 'preview-container';
      
      if (isImage && file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.className = 'preview-image';
        img.file = file;
        previewDiv.appendChild(img);
        
        const reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL(file);
      } else {
        const icon = document.createElement('div');
        icon.className = 'upload-icon';
        icon.textContent = 'üìÑ';
        previewDiv.appendChild(icon);
      }
      
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'preview-details';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'preview-name';
      nameDiv.textContent = file.name;
      
      const sizeDiv = document.createElement('div');
      sizeDiv.className = 'preview-size';
      sizeDiv.textContent = formatFileSize(file.size);
      
      detailsDiv.appendChild(nameDiv);
      detailsDiv.appendChild(sizeDiv);
      previewDiv.appendChild(detailsDiv);
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-file';
      removeBtn.innerHTML = '√ó';
      removeBtn.onclick = function() {
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'none';
        const fileInput = isImage ? 
          document.getElementById('passportPhoto') : 
          document.getElementById('ninSlip');
        fileInput.value = '';
      };
      
      previewDiv.appendChild(removeBtn);
      previewContainer.appendChild(previewDiv);
    }

    function updateFilePreview(previewId, fileName, fileSize) {
      const preview = document.getElementById(previewId);
      if (!preview) return;
      
      preview.innerHTML = '';
      preview.style.display = 'block';
      
      const previewDiv = document.createElement('div');
      previewDiv.className = 'preview-container';
      
      const icon = document.createElement('div');
      icon.className = 'upload-icon';
      icon.textContent = 'üìÑ';
      previewDiv.appendChild(icon);
      
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'preview-details';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'preview-name';
      nameDiv.textContent = fileName;
      
      const sizeDiv = document.createElement('div');
      sizeDiv.className = 'preview-size';
      sizeDiv.textContent = formatFileSize(fileSize || 0);
      
      detailsDiv.appendChild(nameDiv);
      detailsDiv.appendChild(sizeDiv);
      previewDiv.appendChild(detailsDiv);
      
      const noteDiv = document.createElement('div');
      noteDiv.className = 'file-info';
      noteDiv.textContent = 'File saved from previous session. Please re-upload if needed.';
      noteDiv.style.fontSize = '0.8rem';
      noteDiv.style.color = '#ff9800';
      previewDiv.appendChild(noteDiv);
      
      preview.appendChild(previewDiv);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function setupPrivacyScroll() {
      const privacyTerms = document.getElementById('privacyTerms');
      const agreeCheckbox = document.getElementById('agreePrivacy');
      const scrollIndicator = document.getElementById('scrollIndicator');
      
      if (!privacyTerms || !agreeCheckbox || !scrollIndicator) return;
      
      privacyTerms.addEventListener('scroll', function() {
        const scrollPercentage = (this.scrollTop + this.clientHeight) / this.scrollHeight;
        
        if (scrollPercentage > 0.95) {
          agreeCheckbox.disabled = false;
          scrollIndicator.style.display = 'none';
        } else {
          agreeCheckbox.disabled = true;
          scrollIndicator.style.display = 'block';
        }
      });
      
      agreeCheckbox.disabled = true;
    }
  </script>
</body>
</html>