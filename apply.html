<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Marshal Core Nigeria | Application Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://js.paystack.co/v1/inline.js"></script>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Import your color scheme from index.html */
    :root {
      --primary-red: #d32f2f;
      --primary-navy: #1a237e;
      --secondary-blue: #254a93;
      --light-bg: #f8f9fa;
      --dark-text: #333;
    }

    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Header styling matching index.html */
    .header_section {
      background: var(--primary-navy);
      padding: 10px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .rc-number {
      color: white;
      font-weight: bold;
      font-size: 14px;
      background: rgba(255,255,255,0.1);
      padding: 5px 10px;
      border-radius: 4px;
    }

    .logo_box img {
      height: 60px;
      width: auto;
      display: block;
      max-height: 60px;
      object-fit: contain;
    }

    .nav-link {
      color: white !important;
      font-weight: 500;
      padding: 10px 15px !important;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      color: #ffd700 !important;
      transform: translateY(-2px);
    }

    .nav-item.active .nav-link {
      color: #ffd700 !important;
      font-weight: 600;
    }

    /* Progress Bar */
    .progress-container {
      background: white;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      max-width: 900px;
      border-left: 5px solid var(--primary-red);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin: 30px 0;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: #e0e0e0;
      transform: translateY(-50%);
      z-index: 1;
    }

    .progress-bar {
      position: absolute;
      top: 50%;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--secondary-blue));
      transform: translateY(-50%);
      z-index: 2;
      transition: width 0.5s ease;
      width: 0%;
    }

    .step {
      position: relative;
      z-index: 3;
      text-align: center;
      width: 120px;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s ease;
      font-size: 16px;
    }

    .step.active .step-circle {
      background: var(--primary-red);
      border-color: var(--primary-red);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 0 0 5px rgba(211, 47, 47, 0.2);
    }

    .step.completed .step-circle {
      background: var(--secondary-blue);
      border-color: var(--secondary-blue);
      color: white;
    }

    .step.completed .step-circle::after {
      content: '‚úì';
      font-size: 18px;
    }

    .step-label {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .step.active .step-label {
      color: var(--primary-red);
      font-weight: 600;
    }

    /* Main Content Sections */
    .main-container {
      padding: 30px 0;
      min-height: calc(100vh - 200px);
    }

    .section-container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .section-container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card Styling */
    .card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-red), var(--secondary-blue));
    }

    .card h2 {
      color: var(--primary-navy);
      margin-bottom: 20px;
      font-size: 2rem;
      font-weight: 700;
      border-bottom: 2px solid #eee;
      padding-bottom: 15px;
    }

    .card h3 {
      color: var(--secondary-blue);
      margin: 25px 0 15px;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .card-description {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary-navy);
      font-size: 0.95rem;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--secondary-blue);
      background: white;
      box-shadow: 0 0 0 3px rgba(37, 74, 147, 0.1);
    }

    .form-control::placeholder {
      color: #999;
    }

    /* Tier Cards */
    .tier-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .tier-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .tier-card:hover {
      transform: translateY(-5px);
      border-color: var(--secondary-blue);
      box-shadow: 0 10px 30px rgba(37, 74, 147, 0.15);
    }

    .tier-card.selected {
      border-color: var(--primary-red);
      background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
    }

    .tier-card.selected::before {
      content: '‚úì Selected';
      position: absolute;
      top: -12px;
      right: 20px;
      background: var(--primary-red);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 2;
    }

    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .tier-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-navy);
    }

    .tier-price {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-red);
    }

    .tier-price span {
      font-size: 1rem;
      color: #666;
    }

    .benefits-list {
      list-style: none;
      margin: 20px 0;
      padding: 0;
    }

    .benefits-list li {
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      color: #555;
    }

    .benefits-list li::before {
      content: '‚úì';
      color: var(--primary-red);
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
      font-size: 1.1rem;
    }

    .benefits-list li:last-child {
      border-bottom: none;
    }

    /* Buttons */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-red), #c62828);
      color: white;
      border: 2px solid var(--primary-red);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
      background: linear-gradient(135deg, #c62828, var(--primary-red));
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary-blue), #1c3d8c);
      color: white;
      border: 2px solid var(--secondary-blue);
    }

    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(37, 74, 147, 0.3);
      background: linear-gradient(135deg, #1c3d8c, var(--secondary-blue));
      color: white;
    }

    .btn-lg {
      padding: 16px 40px;
      font-size: 1.1rem;
    }

    .btn-full {
      width: 100%;
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Status Messages */
    .status-message {
      padding: 16px 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .status-success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }

    .status-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid var(--primary-red);
    }

    .status-warning {
      background: #fff3e0;
      color: #ef6c00;
      border-left: 4px solid #ff9800;
    }

    .status-info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed #bdbdbd;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      transition: all 0.3s ease;
      background: #fafafa;
      cursor: pointer;
    }

    .file-upload:hover {
      border-color: var(--secondary-blue);
      background: #f5f5f5;
    }

    .file-upload.dragover {
      border-color: var(--primary-red);
      background: #ffeaea;
    }

    .upload-icon {
      font-size: 3rem;
      color: #757575;
      margin-bottom: 15px;
    }

    .file-input {
      display: none;
    }

    .file-label {
      background: linear-gradient(135deg, var(--secondary-blue), var(--primary-navy));
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .file-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 74, 147, 0.3);
    }

    .file-info {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #666;
    }

    .file-preview {
      margin-top: 20px;
      display: none;
    }

    .preview-container {
      display: flex;
      align-items: center;
      gap: 15px;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
    }

    .preview-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .preview-details {
      flex: 1;
    }

    .preview-name {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .preview-size {
      font-size: 0.9rem;
      color: #666;
    }

    .remove-file {
      background: var(--primary-red);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .remove-file:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    /* Terms & Conditions */
    .terms-container {
      max-height: 300px;
      overflow-y: auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin: 20px 0;
    }

    .terms-content {
      line-height: 1.8;
      color: #555;
    }

    .terms-content h4 {
      color: var(--primary-red);
      margin: 20px 0 10px;
      font-size: 1.2rem;
    }

    .terms-content ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .terms-content li {
      margin-bottom: 8px;
    }

    .scroll-indicator {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
      margin: 10px 0;
      font-style: italic;
      padding: 10px;
      background: #f0f7ff;
      border-radius: 5px;
    }

    /* Checkbox */
    .checkbox-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 20px;
      background: #f0f7ff;
      border-radius: 10px;
      margin: 25px 0;
      border: 1px solid #cce7ff;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--primary-red);
    }

    .checkbox-container label {
      flex: 1;
      cursor: pointer;
      line-height: 1.5;
      color: #333;
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 60px 40px;
    }

    .success-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary-red), var(--secondary-blue));
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0 auto 30px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 74, 147, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(37, 74, 147, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 74, 147, 0); }
    }

    .success-title {
      color: var(--primary-red);
      font-size: 2.2rem;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .success-message {
      color: #666;
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }

    .download-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .download-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .download-card:hover {
      border-color: var(--primary-red);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(211, 47, 47, 0.15);
    }

    .download-icon {
      font-size: 2.5rem;
      color: var(--secondary-blue);
      margin-bottom: 15px;
    }

    /* Loader */
    .loader-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 1.2rem;
      color: var(--primary-red);
      font-weight: 600;
    }

    /* Footer */
    .footer_section {
      background: var(--primary-navy);
      color: white;
      padding: 40px 0;
      margin-top: 60px;
    }

    .footer-content {
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer-logo {
      height: 50px;
      margin-bottom: 20px;
      display: inline-block;
      max-height: 50px;
      object-fit: contain;
    }

    .contact-info {
      margin: 20px 0;
      font-size: 0.95rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .copyright {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Payment Amount */
    .payment-amount {
      text-align: center;
      font-size: 3rem;
      font-weight: 800;
      color: var(--primary-red);
      margin: 30px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .payment-summary {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid var(--primary-red);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .progress-container {
        padding: 15px;
        margin: 10px;
      }

      .progress-steps {
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .step {
        width: 100px;
      }

      .card {
        padding: 25px 20px;
        margin: 10px;
      }

      .tier-cards {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .payment-amount {
        font-size: 2.2rem;
      }

      .success-screen {
        padding: 40px 20px;
      }

      .success-title {
        font-size: 1.8rem;
      }
    }

    @media (max-width: 576px) {
      .step {
        width: 80px;
      }

      .step-circle {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .step-label {
        font-size: 0.75rem;
      }

      .card h2 {
        font-size: 1.6rem;
      }

      .tier-card {
        padding: 20px;
      }

      .tier-name {
        font-size: 1.2rem;
      }

      .tier-price {
        font-size: 1.6rem;
      }
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- Header matching index.html -->
  <header class="header_section">
    <div class="container">
      <nav class="navbar navbar-expand-lg custom_nav-container">
        <a class="navbar-brand" href="index.html">
          <span class="rc-number">YA/CLB/10100</span>
          <div class="logo_box">
            <!-- Use local logo -->
            <img src="images/logo.png" alt="Marshal Core Logo" onerror="this.onerror=null;this.src='images/logo.png';">
          </div>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mr-2">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="about.html">About Us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="service.html">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="blog.html">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">Contact us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="officer-portal/login.html">Login</a>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Status Messages -->
    <div class="container">
      <div id="statusMessage" class="status-message"></div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-bar" id="progressBar"></div>
        <div class="step active" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">Pre-Register</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">Select Pathway</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">Payment</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-circle">4</div>
          <div class="step-label">Verify</div>
        </div>
        <div class="step" data-step="5">
          <div class="step-circle">5</div>
          <div class="step-label">Application</div>
        </div>
      </div>
    </div>

    <!-- Section 1: Pre-Registration -->
    <div class="section-container active" id="section1">
      <div class="card">
        <h2>üëã Welcome to Marshal Core Nigeria</h2>
        <p class="card-description">
          Begin your journey to becoming a certified security professional. 
          Fill in your basic details to start the application process.
        </p>
        
        <form id="preRegisterForm">
          <div class="form-group">
            <label for="fullName">Full Name *</label>
            <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
          </div>
          
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" class="form-control" placeholder="Enter your email address" required>
            <small class="file-info">This email will be used for all communications</small>
          </div>
          
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary btn-lg">
              Continue to Pathway Selection ‚Üí
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 2: Pathway Selection -->
    <div class="section-container" id="section2">
      <div class="card">
        <h2>üéØ Select Your Pathway</h2>
        <p class="card-description">
          Choose the pathway that aligns with your career goals and aspirations.
          Both pathways offer comprehensive training and certification.
        </p>
        
        <div class="tier-cards">
          <!-- Regular Pathway -->
          <div class="tier-card" id="regularTier" onclick="selectTier('regular')">
            <div class="tier-header">
              <div class="tier-name">Regular Officer Pathway</div>
              <div class="tier-price">‚Ç¶5,180</div>
            </div>
            
            <h3>Core Benefits</h3>
            <ul class="benefits-list">
              <li>3-month comprehensive recruitment training</li>
              <li>Job placement opportunities nationwide</li>
              <li>Skill development programs & certifications</li>
              <li>Monthly stipends during training period</li>
              <li>Armed forces preparation & discipline</li>
              <li>ICT Knowledge & Basic Tech Skills</li>
              <li>Professional networking opportunities</li>
              <li>Career advancement support</li>
            </ul>
            
            <button type="button" class="btn btn-primary btn-full" onclick="selectTier('regular')">
              Select Regular Pathway
            </button>
          </div>
          
          <!-- VIP Pathway -->
          <div class="tier-card" id="vipTier" onclick="selectTier('vip')">
            <div class="tier-header">
              <div class="tier-name">VIP Security Pathway</div>
              <div class="tier-price">‚Ç¶25,900</div>
            </div>
            
            <h3>Premium Benefits</h3>
            <ul class="benefits-list">
              <li>Official security association status</li>
              <li>Full Tech Career Pathway (SXTM Training)</li>
              <li>Organizational backing & legal protection</li>
              <li>Executive networking with professionals</li>
              <li>Advanced security awareness training</li>
              <li>Priority support & consultation services</li>
              <li>Business protection services</li>
              <li>Advanced ICT & Cybersecurity education</li>
              <li>Personal development & executive training</li>
            </ul>
            
            <button type="button" class="btn btn-primary btn-full" onclick="selectTier('vip')">
              Select VIP Pathway
            </button>
          </div>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="goToSection(1)">
            ‚Üê Back
          </button>
          <button type="button" class="btn btn-primary" id="proceedToPaymentBtn" onclick="proceedToPayment()">
            Proceed to Payment ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Section 3: Payment -->
    <div class="section-container" id="section3">
      <div class="card">
        <h2>üí≥ Payment Details</h2>
        <p class="card-description">
          Complete your payment securely using Paystack. All transactions are encrypted and secure.
        </p>
        
        <div class="payment-summary mb-30">
          <h3>Payment Summary</h3>
          <div class="form-group">
            <label>Selected Pathway</label>
            <input type="text" class="form-control" id="selectedPathway" readonly>
          </div>
          
          <div class="form-group">
            <label>Amount to Pay</label>
            <div class="payment-amount" id="paymentAmount">‚Ç¶0</div>
          </div>
          
          <div class="form-group">
            <label>Email for Payment</label>
            <input type="email" class="form-control" id="paymentEmail" readonly>
          </div>
        </div>
        
        <div class="terms-container">
          <div class="terms-content">
            <h4>Payment Terms & Conditions</h4>
            <ul>
              <li>All payments are processed securely through Paystack</li>
              <li>Application fee is non-refundable once processed</li>
              <li>Payment confirms your intent to join Marshal Core Nigeria</li>
              <li>Receipt will be sent to your email automatically</li>
              <li>For payment issues, contact support@marshalcoreofnigeria.ng</li>
            </ul>
          </div>
        </div>
        
        <div class="checkbox-container mb-30">
          <input type="checkbox" id="agreePayment" required>
          <label for="agreePayment">
            I agree to the payment terms and authorize Marshal Core Nigeria to process my payment.
          </label>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="goToSection(2)">
            ‚Üê Change Pathway
          </button>
          <button type="button" class="btn btn-primary btn-lg" id="payNowBtn" onclick="initiatePayment()">
            Pay Now with Paystack
          </button>
        </div>
        
        <div class="text-center mt-20">
          <img src="https://paystack.com/assets/website/images/badges/verified-badge-with-border.png" alt="Paystack Verified" height="40">
          <p class="file-info">Secured by Paystack ‚Ä¢ PCI DSS Compliant</p>
        </div>
      </div>
    </div>

    <!-- Section 4: Password Verification -->
    <div class="section-container" id="section4">
      <div class="card">
        <h2>üîê Verify Your Identity</h2>
        <p class="card-description">
          A password has been sent to your email. Enter it below to proceed with your application.
        </p>
        
        <form id="passwordForm">
          <div class="form-group">
            <label for="verifyEmail">Email Address</label>
            <input type="email" id="verifyEmail" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label for="password">Application Password *</label>
            <input type="password" id="password" class="form-control" placeholder="Enter the password sent to your email" required>
            <small class="file-info">Password is valid for 7 days ‚Ä¢ One-time use only</small>
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="resendPassword()">
              Resend Password
            </button>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="goToSection(3)">
              ‚Üê Back to Payment
            </button>
            <button type="submit" class="btn btn-primary">
              Verify & Continue ‚Üí
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 5: Application Form -->
    <div class="section-container" id="section5">
      <div class="card">
        <h2>üìù Complete Your Application</h2>
        <p class="card-description">
          Fill in all required details and upload necessary documents. 
          Your passport photo will appear on all generated PDFs.
        </p>
        
        <form id="applicationForm" enctype="multipart/form-data">
          <!-- Hidden Fields -->
          <input type="hidden" id="applicationPassword" name="application_password">
          <input type="hidden" id="applicationEmail" name="email">
          <input type="hidden" id="applicationTier" name="application_tier">
          
          <!-- Section A: Basic Information -->
          <h3>Section A: Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="formFullName">Full Name *</label>
              <input type="text" id="formFullName" name="full_name" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="phoneNumber">Phone Number *</label>
              <input type="tel" id="phoneNumber" name="phone_number" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="ninNumber">NIN Number *</label>
              <input type="text" id="ninNumber" name="nin_number" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="dateOfBirth">Date of Birth *</label>
              <input type="date" id="dateOfBirth" name="date_of_birth" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="stateResidence">State of Residence *</label>
              <input type="text" id="stateResidence" name="state_of_residence" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="lga">Local Government Area *</label>
              <input type="text" id="lga" name="lga" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="address">Residential Address *</label>
              <textarea id="address" name="address" class="form-control" rows="3" required></textarea>
            </div>
          </div>
          
          <!-- Section B: Document Upload -->
          <h3>Section B: Document Upload</h3>
          
          <!-- Passport Photo Upload -->
          <div class="form-group">
            <label>Passport Photograph *</label>
            <div class="file-upload" id="passportUpload">
              <div class="upload-icon">üì∑</div>
              <p>Click to upload or drag and drop</p>
              <p class="file-info">JPG or PNG, max 2MB ‚Ä¢ Required for PDF generation</p>
              <input type="file" id="passportPhoto" name="passport_photo" class="file-input" accept="image/jpeg,image/png" required>
              <label for="passportPhoto" class="file-label">Choose Passport Photo</label>
            </div>
            <div class="file-preview" id="passportPreview"></div>
          </div>
          
          <!-- NIN Slip Upload -->
          <div class="form-group">
            <label>NIN Slip *</label>
            <div class="file-upload" id="ninUpload">
              <div class="upload-icon">üìÑ</div>
              <p>Click to upload or drag and drop</p>
              <p class="file-info">PDF, JPG or PNG, max 5MB</p>
              <input type="file" id="ninSlip" name="nin_slip" class="file-input" accept=".pdf,image/jpeg,image/png" required>
              <label for="ninSlip" class="file-label">Choose NIN Slip</label>
            </div>
            <div class="file-preview" id="ninPreview"></div>
          </div>
          
          <!-- Section C: Reasons for Joining -->
          <h3>Section C: Reasons for Joining</h3>
          <div id="reasonsSection"></div>
          
          <div class="form-group">
            <label for="additionalDetails">Additional Details (Optional)</label>
            <textarea id="additionalDetails" name="additional_details" class="form-control" rows="3" placeholder="Tell us more about your goals and aspirations..."></textarea>
          </div>
          
          <!-- Privacy Notice -->
          <h3>Privacy Notice Agreement</h3>
          <div class="terms-container" id="privacyTerms">
            <div class="terms-content">
              <h4>Privacy Notice - Must Read</h4>
              <p>MBC is an Executive Body under Article 6 Section B of the Constitution of Marshal Core of Nigeria, 2025 (as structured) that processes data in furtherance of our mandate as the sole statutory body empowered to appoint, promote, dismiss and exercise disciplinary control over all officers in the MARSHAL CORE OF NIGERIA (except the Director-General of Marshal core).</p>
              
              <p>We rely on lawful bases for data processing such as consent, substantial public interest, legal obligation and contract. We process various categories of your data so as to ensure that only suitably qualified Nigerians are recruited into the Marshal Core. Subject to your rights as a data subject, this Portal uses "cookies" which may help process your pattern of engagement and thereby create automated responses and notifications that seem most likely to suit your interest. This notice applies to the Marshal Board Committee.</p>
              
              <p>For queries about how we protect your data rights, please contact us:</p>
              <p>Email: info@marshalcoreofnigeria.ng</p>
            </div>
          </div>
          
          <div class="scroll-indicator" id="scrollIndicator">
            Please scroll to the bottom to read and accept
          </div>
          
          <div class="checkbox-container">
            <input type="checkbox" id="agreePrivacy" required>
            <label for="agreePrivacy">
              I have read, understood, and agree to the Privacy Notice and Terms & Conditions of Marshal Core Nigeria
            </label>
          </div>
          
          <!-- Submit Button -->
          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="goToSection(4)">
              ‚Üê Back
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
              Submit Application & Generate PDF
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 6: Success Screen -->
    <div class="section-container" id="section6">
      <div class="card success-screen">
        <div class="success-icon">‚úì</div>
        <h1 class="success-title">Application Submitted Successfully!</h1>
        <p class="success-message">
          Your application has been processed. Your passport photo and logo have been embedded in the generated PDFs.
          Check your email for the documents or download them below.
        </p>
        
        <div class="download-links">
          <div class="download-card" onclick="downloadPDF('application')">
            <div class="download-icon">üìã</div>
            <h3>Application Form PDF</h3>
            <p>Contains your complete application with passport photo</p>
            <button class="btn btn-primary btn-full mt-20">Download Application PDF</button>
          </div>
          
          <div class="download-card" onclick="downloadPDF('terms')">
            <div class="download-icon">üìú</div>
            <h3>Terms & Conditions PDF</h3>
            <p>Official terms document with your details</p>
            <button class="btn btn-primary btn-full mt-20">Download Terms PDF</button>
          </div>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-secondary" onclick="location.reload()">
            Start New Application
          </button>
          <button type="button" class="btn btn-primary" onclick="goToPortal()">
            Go to Applicant Portal ‚Üí
          </button>
        </div>
        
        <div class="contact-info mt-30">
          <p>Need help? Contact us at: support@marshalcoreofnigeria.ng</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer matching index.html -->
  <section class="footer_section">
    <div class="footer-content">
      <!-- Use local footer logo -->
      <img src="images/logo.png" alt="Marshal Core Logo" class="footer-logo" onerror="this.onerror=null;this.src='images/logo.png';">
      <p class="contact-info">
        Marshal Core of Nigeria<br>
        Email: info@marshalcoreofnigeria.ng<br>
        Phone: +234 9137 428 031
      </p>
      <div class="copyright">
        Copyright &copy; 2025 All Rights Reserved By<br>
        Marshal Core of Nigeria<br>
      </div>
    </div>
  </section>

  <!-- Loader -->
  <div class="loader-overlay" id="loader">
    <div class="loader"></div>
    <div class="loader-text" id="loaderText">Processing...</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Global variables
    const API_BASE_URL = 'https://backend-mcn-ltd.onrender.com';
    let userData = {
      fullName: '',
      email: '',
      tier: '',
      amount: 0,
      paymentReference: '',
      preApplicantId: '',
      applicantId: '',
      password: ''
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Application initialized');
      console.log('üîó API Base URL:', API_BASE_URL);
      
      initializeApp();
      setupEventListeners();
      setupFileUploads();
      setupPrivacyScroll();
      
      // Test backend connection
      testBackendConnection();
    });

    async function testBackendConnection() {
      try {
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();
        console.log('‚úÖ Backend connection successful:', data);
        showStatus('Connected to backend successfully', 'success');
      } catch (error) {
        console.warn('‚ö†Ô∏è Backend connection test failed:', error);
        showStatus('Backend connection test failed. Some features may not work.', 'warning');
      }
    }

    function initializeApp() {
      // Initialize the progress bar
      updateProgressBar(1);
      
      // Check for payment callback parameters
      handlePaymentCallback();
      
      // Disable proceed button initially
      document.getElementById('proceedToPaymentBtn').disabled = true;
    }

    function setupEventListeners() {
      // Pre-registration form
      const preRegisterForm = document.getElementById('preRegisterForm');
      if (preRegisterForm) {
        preRegisterForm.addEventListener('submit', function(e) {
          e.preventDefault();
          handlePreRegistration();
        });
      }
      
      // Password form
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
          e.preventDefault();
          handlePasswordVerification();
        });
      }
      
      // Application form
      const applicationForm = document.getElementById('applicationForm');
      if (applicationForm) {
        applicationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          handleApplicationSubmit();
        });
      }
    }

    // Progress and Navigation
    function goToSection(sectionNumber) {
      console.log(`Navigating to section ${sectionNumber}`);
      
      // Hide all sections
      const sections = document.querySelectorAll('.section-container');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      // Show target section
      const targetSection = document.getElementById(`section${sectionNumber}`);
      if (targetSection) {
        targetSection.classList.add('active');
      } else {
        console.error(`Section ${sectionNumber} not found!`);
        return;
      }
      
      // Update progress bar
      updateProgressBar(sectionNumber);
      
      // Update steps
      const steps = document.querySelectorAll('.step');
      steps.forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNum = parseInt(step.getAttribute('data-step'));
        if (stepNum <= sectionNumber) {
          if (stepNum === sectionNumber) {
            step.classList.add('active');
          } else {
            step.classList.add('completed');
          }
        }
      });
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateProgressBar(currentStep) {
      const progressBar = document.getElementById('progressBar');
      if (!progressBar) return;
      
      const totalSteps = 5;
      const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
      progressBar.style.width = `${progressPercentage}%`;
    }

    // Helper function to safely read response body (JSON or text)
    async function readBodySafely(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      try {
        if (ct.includes('application/json')) return await res.json();
        return await res.text();
      } catch (e) {
        return await res.text();
      }
    }

    // Step 1: Pre-registration
    async function handlePreRegistration() {
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (!fullName || !email) {
        showStatus('Please fill in all required fields', 'error');
        return;
      }
      
      if (!validateEmail(email)) {
        showStatus('Please enter a valid email address', 'error');
        return;
      }
      
      showLoader('Registering your application...');
      
      try {
        // Step 1: Pre-register - FIXED: Using correct endpoint with JSON body
        const response = await fetch(`${API_BASE_URL}/pre-applicant/register`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            full_name: fullName,
            email: email
          })
        });
        
        // Use safe parsing to avoid JSON parse errors
        const contentType = response.headers.get('content-type') || '';
        if (!response.ok) {
          const body = await readBodySafely(response);
          
          // Handle existing user cases
          if (typeof body === 'object') {
            if (body.status === 'exists_not_paid') {
              hideLoader();
              userData = { ...userData, fullName, email, preApplicantId: body.pre_applicant_id };
              showStatus('Account found. Please select your pathway.', 'info');
              goToSection(2);
              return;
            } else if (body.status === 'payment_completed') {
              hideLoader();
              userData = { ...userData, fullName, email, preApplicantId: body.pre_applicant_id };
              showStatus('Payment already completed. Generating password...', 'info');
              generatePassword(email, fullName);
              return;
            } else if (body.detail) {
              throw new Error(body.detail);
            }
          }
          throw new Error(typeof body === 'string' ? body : 'Registration failed');
        }
        
        // Parse successful response
        const data = await readBodySafely(response);
        console.log('üìã Pre-registration response:', data);
        
        // New user registration successful
        userData = { 
          ...userData, 
          fullName, 
          email, 
          preApplicantId: data.pre_applicant_id || data.id 
        };
        
        hideLoader();
        showStatus('Registration successful! Please select your pathway.', 'success');
        goToSection(2);
        
      } catch (error) {
        hideLoader();
        console.error('Registration error:', error);
        showStatus(`Registration failed: ${error.message}`, 'error');
      }
    }

    // Step 2: Tier Selection
    function selectTier(tier) {
      console.log(`Selected tier: ${tier}`);
      
      // Remove selected class from all tiers
      document.getElementById('regularTier').classList.remove('selected');
      document.getElementById('vipTier').classList.remove('selected');
      
      // Add selected class to chosen tier
      document.getElementById(`${tier}Tier`).classList.add('selected');
      
      // Update user data
      userData.tier = tier;
      userData.amount = tier === 'regular' ? 5180 : 25900;
      
      // Enable proceed button
      document.getElementById('proceedToPaymentBtn').disabled = false;
    }

    function proceedToPayment() {
      if (!userData.tier) {
        showStatus('Please select a pathway first', 'error');
        return;
      }
      
      // Update payment section with selected tier
      const pathwayName = userData.tier === 'regular' ? 'Regular Officer Pathway' : 'VIP Security Pathway';
      document.getElementById('selectedPathway').value = pathwayName;
      document.getElementById('paymentAmount').textContent = `‚Ç¶${userData.amount.toLocaleString()}`;
      document.getElementById('paymentEmail').value = userData.email;
      
      goToSection(3);
    }

    // Step 3: Payment - FIXED with robust error handling and correct API calls
    async function initiatePayment() {
      if (!document.getElementById('agreePayment').checked) {
        showStatus('Please agree to the payment terms', 'error');
        return;
      }
      
      showLoader('Initializing payment...');
      
      try {
        const email = userData.email;
        const tier = userData.tier;
        
        if (!email || !tier) {
          throw new Error('Missing email or tier selection');
        }
        
        // Step 1: Select tier in backend - FIXED: Using POST with query parameters as backend expects
        const tierUrl = `${API_BASE_URL}/pre-applicant/select-tier?email=${encodeURIComponent(email)}&tier=${encodeURIComponent(tier)}`;
        const tierResponse = await fetch(tierUrl, {
          method: 'POST',
          headers: { 
            'Accept': 'application/json'
          }
        });
        
        // Safely handle response
        if (!tierResponse.ok) {
          const body = await readBodySafely(tierResponse);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Tier selection failed: ${tierResponse.status} - ${errorMsg}`);
        }
        
        // Ensure we have JSON response
        const tierContentType = tierResponse.headers.get('content-type') || '';
        if (!tierContentType.includes('application/json')) {
          const text = await tierResponse.text();
          throw new Error(`Expected JSON from tier selection but got: ${text.substring(0, 200)}`);
        }
        
        const tierData = await readBodySafely(tierResponse);
        console.log('Tier selection response:', tierData);
        
        // Step 2: Initiate payment - FIXED: Using correct JSON payload
        const paymentResponse = await fetch(`${API_BASE_URL}/api/payments/initiate`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email: userData.email,
            payment_type: userData.tier,
            user_type: 'pre_applicant'
          })
        });
        
        // Safely handle payment response
        if (!paymentResponse.ok) {
          const body = await readBodySafely(paymentResponse);
          
          // Handle special cases
          if (typeof body === 'object') {
            if (body.status === 'already_paid') {
              hideLoader();
              showStatus('Payment already completed. Generating password...', 'info');
              await generatePassword(userData.email, userData.fullName);
              return;
            } else if (body.status === 'pending' && body.authorization_url) {
              hideLoader();
              window.open(body.authorization_url, '_blank');
              showStatus('Payment pending. A new window has been opened for you to complete the payment.', 'info');
              return;
            }
          }
          
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Payment initiation failed: ${paymentResponse.status} - ${errorMsg}`);
        }
        
        // Ensure we have JSON response
        const paymentContentType = paymentResponse.headers.get('content-type') || '';
        if (!paymentContentType.includes('application/json')) {
          const text = await paymentResponse.text();
          throw new Error(`Expected JSON from payment initiation but got: ${text.substring(0, 200)}`);
        }
        
        const paymentData = await readBodySafely(paymentResponse);
        console.log('Payment initiation response:', paymentData);
        
        // Store payment reference
        userData.paymentReference = paymentData.payment_reference;
        
        // Initialize Paystack
        if (typeof PaystackPop === 'undefined') {
          throw new Error('Paystack script not loaded');
        }
        
        hideLoader();
        
        const handler = PaystackPop.setup({
          key: 'pk_test_c6ff4f4622c7e35eb557e9e3be0c7424b5d0a3d4', // Your test key - replace with your actual key
          email: userData.email,
          amount: userData.amount * 100, // Convert to kobo
          currency: 'NGN',
          ref: paymentData.payment_reference,
          metadata: {
            full_name: userData.fullName,
            tier: userData.tier,
            pre_applicant_id: userData.preApplicantId
          },
          callback: function(response) {
            console.log('Payment callback:', response);
            // Payment successful
            verifyPayment(response.reference);
          },
          onClose: function() {
            showStatus('Payment window closed. You can try again.', 'warning');
          }
        });
        
        handler.openIframe();
        
      } catch (error) {
        hideLoader();
        console.error('Payment initiation error:', error);
        showStatus(`Payment failed: ${error.message}`, 'error');
      }
    }

    async function verifyPayment(reference) {
      showLoader('Verifying payment...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/payments/verify/${reference}`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        // Safely handle response
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Payment verification failed: ${response.status} - ${errorMsg}`);
        }
        
        // Ensure JSON response
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON from payment verification but got: ${text.substring(0, 200)}`);
        }
        
        const data = await readBodySafely(response);
        console.log('Payment verification response:', data);
        
        // Payment verified, generate password
        await generatePassword(userData.email, userData.fullName);
        
      } catch (error) {
        hideLoader();
        console.error('Payment verification error:', error);
        showStatus(`Verification failed: ${error.message}`, 'error');
      }
    }

    async function generatePassword(email, fullName) {
      showLoader('Generating application password...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/access/generate-password`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email: email })
        });
        
        // Safely handle response
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Password generation failed: ${response.status} - ${errorMsg}`);
        }
        
        // Ensure JSON response
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON from password generation but got: ${text.substring(0, 200)}`);
        }
        
        const data = await readBodySafely(response);
        console.log('Password generation response:', data);
        
        hideLoader();
        showStatus('Password generated and sent to your email!', 'success');
        
        // Pre-fill email in verification section
        document.getElementById('verifyEmail').value = email;
        userData.password = data.password || '';
        
        // Move to password verification section
        goToSection(4);
        
      } catch (error) {
        hideLoader();
        console.error('Password generation error:', error);
        showStatus(`Password generation failed: ${error.message}`, 'error');
      }
    }

    async function resendPassword() {
      showLoader('Resending password...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/access/generate-password`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email: userData.email })
        });
        
        // Safely handle response
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Failed to resend password: ${response.status} - ${errorMsg}`);
        }
        
        // Ensure JSON response
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON from password resend but got: ${text.substring(0, 200)}`);
        }
        
        const data = await readBodySafely(response);
        
        hideLoader();
        showStatus('Password resent to your email!', 'success');
        
      } catch (error) {
        hideLoader();
        console.error('Resend password error:', error);
        showStatus(`Failed to resend password: ${error.message}`, 'error');
      }
    }

    // Step 4: Password Verification
    async function handlePasswordVerification() {
      const password = document.getElementById('password').value.trim();
      const email = document.getElementById('verifyEmail').value.trim();
      
      if (!email || !password) {
        showStatus('Both email and password are required', 'error');
        return;
      }
      
      showLoader('Verifying password...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/access/verify`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        });
        
        // Safely handle response
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Password verification failed: ${response.status} - ${errorMsg}`);
        }
        
        // Ensure JSON response
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON from password verification but got: ${text.substring(0, 200)}`);
        }
        
        const data = await readBodySafely(response);
        console.log('Password verification response:', data);
        
        // Store verified password
        userData.password = password;
        
        // Accept privacy notice
        await acceptPrivacyNotice();
        
        // Load application form
        loadApplicationForm();
        
        hideLoader();
        showStatus('Password verified successfully!', 'success');
        goToSection(5);
        
      } catch (error) {
        hideLoader();
        console.error('Password verification error:', error);
        showStatus(`Verification failed: ${error.message}`, 'error');
      }
    }

    async function acceptPrivacyNotice() {
      try {
        const response = await fetch(`${API_BASE_URL}/privacy/accept`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email: userData.email })
        });
        
        if (!response.ok) {
          console.warn('Privacy acceptance failed');
        }
      } catch (error) {
        console.warn('Privacy acceptance error:', error);
      }
    }

    function loadApplicationForm() {
      // Pre-fill form with user data
      document.getElementById('formFullName').value = userData.fullName;
      document.getElementById('applicationEmail').value = userData.email;
      document.getElementById('applicationPassword').value = userData.password;
      document.getElementById('applicationTier').value = userData.tier;
      
      // Load reasons for joining based on tier
      const reasonsSection = document.getElementById('reasonsSection');
      reasonsSection.innerHTML = '';
      
      if (userData.tier === 'regular') {
        reasonsSection.innerHTML = `
          <div class="form-group">
            <label>Select UP TO 3 reasons for joining:</label>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="seeking_employment" id="reason1">
              <label for="reason1">Seeking Employment & Work</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="skill_acquisition" id="reason2">
              <label for="reason2">Skill Acquisition & Handwork Training</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="armed_forces" id="reason3">
              <label for="reason3">Armed Forces Preparation</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="personal_development" id="reason4">
              <label for="reason4">Personal Development & Discipline</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="ict_knowledge" id="reason5">
              <label for="reason5">ICT Knowledge & Basic Computer Skills</label>
            </div>
            <small class="file-info">Select 1-3 options only</small>
          </div>
        `;
      } else {
        reasonsSection.innerHTML = `
          <div class="form-group">
            <label>Select ALL reasons that apply:</label>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="security_association" id="reason6">
              <label for="reason6">Security Association & Legal Protection</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="tech_career" id="reason7">
              <label for="reason7">Tech Career Pathway (Full SXTM Training)</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="networking" id="reason8">
              <label for="reason8">Networking & Professional Status Enhancement</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="security_awareness" id="reason9">
              <label for="reason9">Security Awareness & Risk Management</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="business_protection" id="reason10">
              <label for="reason10">Business Protection & Organizational Backup</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="cybersecurity" id="reason11">
              <label for="reason11">Advanced ICT & Cybersecurity Education</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" name="selected_reasons" value="executive_training" id="reason12">
              <label for="reason12">Personal Development & Executive Training</label>
            </div>
            <small class="file-info">Select all that apply</small>
          </div>
        `;
      }
    }

    // Step 5: Application Form Submission
    async function handleApplicationSubmit() {
      // Validate passport upload
      const passportFile = document.getElementById('passportPhoto').files[0];
      if (!passportFile) {
        showStatus('Passport photo is required for PDF generation', 'error');
        return;
      }
      
      // Validate file types and sizes
      if (passportFile.size > 2 * 1024 * 1024) {
        showStatus('Passport photo must be less than 2MB', 'error');
        return;
      }
      
      if (!['image/jpeg', 'image/png'].includes(passportFile.type)) {
        showStatus('Passport must be JPG or PNG format', 'error');
        return;
      }
      
      showLoader('Submitting application and generating PDFs...');
      
      try {
        // Collect form data
        const formData = new FormData(document.getElementById('applicationForm'));
        
        // Get selected reasons
        const selectedReasons = [];
        document.querySelectorAll('input[name="selected_reasons"]:checked').forEach(checkbox => {
          selectedReasons.push(checkbox.value);
        });
        
        if (selectedReasons.length === 0) {
          throw new Error('Please select at least one reason for joining');
        }
        
        if (userData.tier === 'regular' && selectedReasons.length > 3) {
          throw new Error('Regular applicants can select up to 3 reasons only');
        }
        
        formData.set('selected_reasons', JSON.stringify(selectedReasons));
        
        // Submit application
        const response = await fetch(`${API_BASE_URL}/apply`, {
          method: 'POST',
          body: formData
        });
        
        // Safely handle response
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`Application submission failed: ${response.status} - ${errorMsg}`);
        }
        
        // Ensure JSON response
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON from application submission but got: ${text.substring(0, 200)}`);
        }
        
        const data = await readBodySafely(response);
        console.log('Application submission response:', data);
        
        // Store applicant ID for PDF downloads
        userData.applicantId = data.id || data.applicant_id;
        
        hideLoader();
        showStatus('Application submitted successfully! PDFs have been generated with your passport photo.', 'success');
        
        // Move to success screen
        goToSection(6);
        
      } catch (error) {
        hideLoader();
        console.error('Application submission error:', error);
        showStatus(`Submission failed: ${error.message}`, 'error');
      }
    }

    // Step 6: PDF Downloads
    async function downloadPDF(type) {
      if (!userData.applicantId) {
        showStatus('Applicant ID not found. Please contact support.', 'error');
        return;
      }
      
      showLoader(`Generating ${type} PDF...`);
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/pdf/${type}/${userData.applicantId}?user_type=applicant`,
          {
            method: 'GET'
          }
        );
        
        if (!response.ok) {
          const body = await readBodySafely(response);
          const errorMsg = typeof body === 'object' ? (body.detail || JSON.stringify(body)) : body;
          throw new Error(`PDF generation failed: ${response.status} - ${errorMsg}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `marshal_core_${type}_${userData.applicantId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoader();
        showStatus(`${type === 'application' ? 'Application' : 'Terms'} PDF downloaded successfully!`, 'success');
        
      } catch (error) {
        hideLoader();
        console.error('PDF download error:', error);
        showStatus(`Failed to download PDF: ${error.message}`, 'error');
      }
    }

    function goToPortal() {
      // Redirect to applicant portal
      window.location.href = 'https://marshalcoreofnigeria.ng/portal';
    }

    // Utility functions
    function showLoader(text = 'Processing...') {
      document.getElementById('loaderText').textContent = text;
      document.getElementById('loader').style.display = 'flex';
    }

    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Handle Paystack callback from URL parameters
    function handlePaymentCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const reference = urlParams.get('reference');
      const trxref = urlParams.get('trxref');
      
      if (reference || trxref) {
        showLoader('Verifying payment...');
        verifyPayment(reference || trxref);
      }
    }

    // File Upload Functions
    function setupFileUploads() {
      setupFileUpload('passportUpload', 'passportPhoto', 'passportPreview', true);
      setupFileUpload('ninUpload', 'ninSlip', 'ninPreview', false);
    }

    function setupFileUpload(dropZoneId, fileInputId, previewId, isImage) {
      const dropZone = document.getElementById(dropZoneId);
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewId);
      
      if (!dropZone || !fileInput || !preview) return;
      
      // Click to upload
      dropZone.addEventListener('click', () => fileInput.click());
      
      // Handle file selection
      fileInput.addEventListener('change', function() {
        handleFileSelect(this.files[0], preview, isImage);
      });
      
      // Drag and drop
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropZone.classList.add('dragover');
      }
      
      function unhighlight() {
        dropZone.classList.remove('dragover');
      }
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      dropZone.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFileSelect(files[0], preview, isImage);
      });
    }

    function handleFileSelect(file, previewContainer, isImage) {
      if (!file) return;
      
      previewContainer.innerHTML = '';
      previewContainer.style.display = 'block';
      
      const previewDiv = document.createElement('div');
      previewDiv.className = 'preview-container';
      
      if (isImage && file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.className = 'preview-image';
        img.file = file;
        previewDiv.appendChild(img);
        
        const reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL(file);
      } else {
        const icon = document.createElement('div');
        icon.className = 'upload-icon';
        icon.textContent = 'üìÑ';
        previewDiv.appendChild(icon);
      }
      
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'preview-details';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'preview-name';
      nameDiv.textContent = file.name;
      
      const sizeDiv = document.createElement('div');
      sizeDiv.className = 'preview-size';
      sizeDiv.textContent = formatFileSize(file.size);
      
      detailsDiv.appendChild(nameDiv);
      detailsDiv.appendChild(sizeDiv);
      previewDiv.appendChild(detailsDiv);
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-file';
      removeBtn.innerHTML = '√ó';
      removeBtn.onclick = function() {
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'none';
        const fileInput = isImage ? 
          document.getElementById('passportPhoto') : 
          document.getElementById('ninSlip');
        fileInput.value = '';
      };
      
      previewDiv.appendChild(removeBtn);
      previewContainer.appendChild(previewDiv);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function setupPrivacyScroll() {
      const privacyTerms = document.getElementById('privacyTerms');
      const agreeCheckbox = document.getElementById('agreePrivacy');
      const scrollIndicator = document.getElementById('scrollIndicator');
      
      if (!privacyTerms || !agreeCheckbox || !scrollIndicator) return;
      
      privacyTerms.addEventListener('scroll', function() {
        const scrollPercentage = (this.scrollTop + this.clientHeight) / this.scrollHeight;
        
        if (scrollPercentage > 0.95) {
          agreeCheckbox.disabled = false;
          scrollIndicator.style.display = 'none';
        } else {
          agreeCheckbox.disabled = true;
          scrollIndicator.style.display = 'block';
        }
      });
      
      // Initial check
      agreeCheckbox.disabled = true;
    }
  </script>
</body>
</html>